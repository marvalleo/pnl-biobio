<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Forja - Gesti贸n de Cursos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --pnl-blue: #0f172a;
            --pnl-gold: #fba931;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f3f4f6;
            color: var(--pnl-blue);
        }
    </style>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script>
        // Protecci贸n de Ruta
        window.addEventListener('DOMContentLoaded', async () => {
            const role = localStorage.getItem('pnl_user_role');
            if (role !== 'super_admin' && role !== 'admin_forja') {
                alert('Acceso no autorizado');
                window.location.href = 'forja-login.html';
                return;
            }
            loadCourses();
        });

        async function logout() {
            await supabaseClient.auth.signOut();
            localStorage.removeItem('pnl_user_role');
            window.location.href = 'index.html';
        }
    </script>
</head>

<body class="min-h-screen">
    <nav
        class="bg-white shadow-md border-b-4 border-[#fba931] px-6 py-1 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <a href="admin-dashboard.html" class="flex items-center gap-3 hover:opacity-80">
                <!-- Logo PNL Ajustado -->
                <img src="wp-content/uploads/2026/pnl-del-biobio01.png" alt="Logo PNL"
                    style="max-height: 78px; margin-top: 5px;">
                <span class="h-8 w-[1px] bg-gray-300 mx-1"></span> <!-- Separador vertical -->
                <span class="font-black text-lg uppercase">Admin Forja</span>
            </a>
        </div>
        <button onclick="logout()"
            class="text-[10px] font-bold uppercase bg-gray-100 px-4 py-2 rounded-lg hover:bg-gray-200">Cerrar
            Sesi贸n</button>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-10">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-900 uppercase text-[#0f172a]">Gesti贸n de Cursos</h1>
            <div class="flex gap-3">
                <button onclick="createNewEvent()"
                    class="bg-white text-[#0f172a] border-2 border-[#0f172a] px-6 py-3 rounded-xl font-900 text-xs uppercase tracking-widest hover:bg-gray-50 flex items-center gap-2 transition-all">
                    <span class="material-symbols-outlined">calendar_add_on</span> Nuevo Evento
                </button>
                <button onclick="openModal()"
                    class="bg-[#fba931] text-[#0f172a] px-6 py-3 rounded-xl font-900 text-xs uppercase tracking-widest shadow-lg hover:brightness-110 flex items-center gap-2 transition-all">
                    <span class="material-symbols-outlined">add</span> Nuevo Curso
                </button>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-gray-50 border-b border-gray-100">
                    <tr>
                        <th class="p-6 text-[10px] font-black uppercase text-gray-400 tracking-wider"></th>
                        <th class="p-6 text-[10px] font-black uppercase text-gray-400 tracking-wider">Curso / M贸dulo
                        </th>
                        <th class="p-6 text-[10px] font-black uppercase text-gray-400 tracking-wider">Contenido</th>
                        <th class="p-6 text-[10px] font-black uppercase text-gray-400 tracking-wider">Estado</th>
                        <th class="p-6 text-[10px] font-black uppercase text-gray-400 tracking-wider">ltima Modif.</th>
                        <th class="p-6 text-[10px] font-black uppercase text-gray-400 tracking-wider text-right">
                            Acciones</th>
                    </tr>
                </thead>
                <tbody id="course-table-body" class="divide-y divide-gray-100">
                    <tr>
                        <td colspan="6" class="p-10 text-center text-gray-400 italic">Cargando cursos desde la nube...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Modal Nuevo/Editar Curso -->
    <div id="course-modal"
        class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-lg w-full shadow-2xl mx-4">
            <h2 id="modal-title" class="text-2xl font-900 uppercase mb-6 text-[#0f172a]">Nuevo Curso</h2>
            <form id="course-form" onsubmit="saveCourse(event)" class="space-y-4">
                <input type="hidden" id="course-id">
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 ml-1">T铆tulo del Curso</label>
                    <input type="text" id="course-title" required
                        class="w-full bg-gray-50 border border-gray-100 p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 ml-1">Descripci贸n del Curso</label>
                    <textarea id="course-description"
                        class="w-full bg-gray-50 border border-gray-100 p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none h-24"
                        placeholder="De qu茅 trata este curso..."></textarea>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 ml-1">Tipo de Contenedor /
                        M贸dulo</label>
                    <select id="course-level"
                        class="w-full bg-gray-50 border border-gray-100 p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none font-bold">
                        <option value="M贸dulo B谩sico"> M贸dulo B谩sico (Academia)</option>
                        <option value="M贸dulo Avanzado"> M贸dulo Avanzado (Academia)</option>
                        <option value="Agenda Regional"> Agenda Regional (Eventos)</option>
                        <option value="Especializaci贸n"> Especializaci贸n</option>
                    </select>
                    <p class="text-[9px] text-gray-400 mt-1 uppercase font-bold italic">* Usa "Agenda Regional" para
                        agrupar talleres y webinars.</p>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 ml-1">Imagen URL</label>
                    <input type="url" id="course-image" placeholder="https://..."
                        class="w-full bg-gray-50 border border-gray-100 p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 ml-1">Estado</label>
                    <select id="course-status"
                        class="w-full bg-gray-50 border border-gray-100 p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none font-bold">
                        <option value="published">Publicado</option>
                        <option value="draft">Borrador</option>
                        <option value="archived">Archivado</option>
                    </select>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 bg-gray-100 text-gray-600 py-4 rounded-xl font-900 uppercase text-xs hover:bg-gray-200">Cancelar</button>
                    <button type="submit"
                        class="flex-1 bg-[#fba931] text-[#0f172a] py-4 rounded-xl font-900 uppercase text-xs hover:brightness-110 shadow-lg">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const tableBody = document.getElementById('course-table-body');
        const modal = document.getElementById('course-modal');

        async function loadCourses() {
            try {
                const { data, error } = await supabaseClient
                    .from('courses')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-gray-400">No hay cursos creados a煤n.</td></tr>';
                    return;
                }

                // Obtener conteo de lecciones
                const { data: lessonsCount } = await supabaseClient.from('lessons').select('course_id');
                const counts = (lessonsCount || []).reduce((acc, l) => {
                    acc[l.course_id] = (acc[l.course_id] || 0) + 1;
                    return acc;
                }, {});

                tableBody.innerHTML = data.map(course => `
                    <tr class="hover:bg-gray-50 transition-colors group">
                        <td class="p-6 w-24">
                            <div class="w-16 h-10 rounded-lg overflow-hidden bg-gray-100 border border-gray-100">
                                <img src="${course.image_url || 'https://images.unsplash.com/photo-1526628953301-3e589a6a8b74?auto=format&fit=crop&q=80&w=200'}" 
                                     class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                            </div>
                        </td>
                        <td class="p-6">
                            <div class="font-bold uppercase text-sm" title="${course.description || ''}">${course.title}</div>
                            <div class="text-[10px] font-black text-[#fba931] uppercase tracking-tighter">${course.level}</div>
                        </td>
                        <td class="p-6">
                            <div class="flex flex-col">
                                <span class="text-xs font-black text-[#0f172a]">${counts[course.id] || 0}</span>
                                <span class="text-[8px] font-bold text-gray-400 uppercase tracking-tighter">Items</span>
                            </div>
                        </td>
                        <td class="p-6">
                            <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase ${course.status === 'published' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                ${course.status === 'published' ? 'Publicado' : course.status === 'draft' ? 'Borrador' : 'Archivado'}
                            </span>
                        </td>
                        <td class="p-6 text-xs text-gray-400 font-bold">${new Date(course.created_at).toLocaleDateString()}</td>
                        <td class="p-6 text-right flex justify-end gap-2">
                            <a href="admin-lecciones.html?course_id=${course.id}" 
                               title="Gestionar Contenido"
                               class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg flex items-center justify-center transition-colors">
                               <span class="material-symbols-outlined">menu_book</span>
                            </a>
                            <button onclick='editCourse(${JSON.stringify(course)})' 
                                    title="Editar Propiedades"
                                    class="p-2 text-[#0f172a] hover:bg-gray-100 rounded-lg transition-colors">
                                <span class="material-symbols-outlined">edit</span>
                            </button>
                            <button onclick="deleteCourse('${course.id}')" 
                                    title="Eliminar Curso"
                                    class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
                tableBody.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-red-500 font-bold uppercase text-xs">Error de conexi贸n con la nube.</td></tr>';
            }
        }

        function openModal() {
            document.getElementById('course-form').reset();
            document.getElementById('course-id').value = '';
            document.getElementById('modal-title').textContent = 'Nuevo Curso';
            modal.classList.remove('hidden');
        }

        function closeModal() { modal.classList.add('hidden'); }

        async function saveCourse(e) {
            e.preventDefault();
            const id = document.getElementById('course-id').value;
            const courseData = {
                title: document.getElementById('course-title').value,
                description: document.getElementById('course-description').value,
                level: document.getElementById('course-level').value,
                image_url: document.getElementById('course-image').value || null,
                status: document.getElementById('course-status').value
            };

            try {
                let error;
                if (id) {
                    ({ error } = await supabaseClient.from('courses').update(courseData).eq('id', id));
                } else {
                    ({ error } = await supabaseClient.from('courses').insert([courseData]));
                }

                if (error) throw error;
                alert('Curso guardado con 茅xito.');
                closeModal();
                loadCourses();
            } catch (err) {
                alert('Error al guardar: ' + err.message);
            }
        }

        async function deleteCourse(id) {
            if (!confirm('驴Seguro que deseas eliminar este curso? Se perder谩 toda la informaci贸n asociada.')) return;
            try {
                const { error } = await supabaseClient.from('courses').delete().eq('id', id);
                if (error) throw error;
                loadCourses();
            } catch (err) { alert(err.message); }
        }

        function editCourse(course) {
            openModal();
            document.getElementById('course-id').value = course.id;
            document.getElementById('course-title').value = course.title;
            document.getElementById('course-description').value = course.description || '';
            document.getElementById('course-level').value = course.level;
            document.getElementById('course-image').value = course.image_url || '';
            document.getElementById('course-status').value = course.status;
            document.getElementById('modal-title').textContent = 'Editar Curso';
        }
    </script>
</body>
</body>

</html>