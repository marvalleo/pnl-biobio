<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debates - Forja Libertaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        :root {
            --pnl-blue: #0f172a;
            --pnl-gold: #fba931;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f8fafc;
            color: var(--pnl-blue);
        }

        .serif {
            font-family: 'Playfair Display', serif;
        }

        .premium-card {
            background: #ffffff;
            border-radius: 2.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.03);
            border: 1px solid #f1f5f9;
        }

        .reply-card {
            background: #ffffff;
            border-radius: 1.5rem;
            border-left: 4px solid #fba931;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">
    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b-4 border-[#fba931] shrink-0 sticky top-0 z-50">
        <div class="max-w-[1600px] mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-6">
                <a href="forja-foros.html" class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-3xl text-[#0f172a]">arrow_back</span>
                </a>
                <div class="h-8 w-[1px] bg-gray-100"></div>
                <div class="flex flex-col">
                    <span class="text-[9px] font-black uppercase text-[#fba931] mb-1 tracking-widest">Debate en
                        Curso</span>
                    <span id="nav-topic-title"
                        class="font-black text-lg uppercase leading-none truncate max-w-[200px] md:max-w-md">Cargando...</span>
                </div>
            </div>

            <div id="user-menu-container" class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-gray-100 animate-pulse"></div>
            </div>
        </div>
    </nav>

    <main class="flex-1 max-w-4xl mx-auto w-full p-6 lg:p-10">
        <!-- Hilo Principal (Topic) -->
        <section id="topic-header" class="mb-12">
            <div class="animate-pulse space-y-4">
                <div class="h-64 bg-white rounded-[2.5rem]"></div>
            </div>
        </section>

        <!-- Divisor -->
        <div class="flex items-center gap-4 mb-8">
            <div class="h-[1px] bg-gray-200 flex-1"></div>
            <span id="replies-count"
                class="text-[10px] font-black uppercase text-gray-400 tracking-widest">Respuestas</span>
            <div class="h-[1px] bg-gray-200 flex-1"></div>
        </div>

        <!-- Respuestas (Posts) -->
        <section id="posts-container" class="space-y-6 mb-20">
            <!-- Respuestas din치micas -->
        </section>

        <!-- Caja de Respuesta -->
        <section class="premium-card p-8 sticky bottom-10 shadow-2xl border-t-4 border-[#fba931]">
            <h3 class="text-xs font-black uppercase text-[#0f172a] mb-4 tracking-widest">Tu Aporte al Debate</h3>
            <form id="reply-form" class="flex flex-col gap-4">
                <textarea id="reply-content" required rows="3"
                    placeholder="Escribe tu respuesta con argumentos libertarios..."
                    class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 text-sm font-medium text-[#0f172a] focus:ring-2 focus:ring-[#fba931]/50 outline-none resize-none"></textarea>
                <div class="flex justify-end">
                    <button type="submit"
                        class="bg-[#0f172a] text-white px-10 py-4 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-xl hover:scale-105 transition-all flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">send</span> Enviar Respuesta
                    </button>
                </div>
            </form>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="shared.js"></script>
    <script>
        let topicId = null;
        let userProfile = null;

        window.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            topicId = urlParams.get('id');

            if (!topicId) {
                topicId = sessionStorage.getItem('current_topic_id');
                console.log("游댃 Backup ID detectado:", topicId);
            }

            console.log("游댌 URL Search:", window.location.search);
            console.log("游댌 Final Topic ID:", topicId);

            // Esperar a que Supabase se inicialice (m치ximo 6 segundos)
            let attempts = 0;
            while (!window.isSupabaseInit && attempts < 60) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
            }

            if (!topicId || topicId === 'undefined' || topicId === 'null') {
                showToast("Referencia al debate no encontrada (ID Inv치lido).", "error");
                console.error("ID de debate no v치lido detectado:", topicId);
                setTimeout(() => window.location.href = 'forja-foros.html', 2000);
                return;
            }

            if (!window.isSupabaseInit) {
                showToast("Error de conexi칩n: El servidor no responde.", "warning");
                setTimeout(() => window.location.href = 'forja-foros.html', 3000);
                return;
            }

            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) { window.location.href = 'forja-login.html'; return; }

            const { data: profile } = await supabaseClient.from('profiles').select('*').eq('auth_id', user.id).single();
            userProfile = profile;

            if (typeof initNavbar === 'function') initNavbar();
            await loadTopicDetails();
            await loadPosts();

            // Suscripci칩n a nuevos posts si supabaseClient est치 listo
            if (window.isSupabaseInit && supabaseClient.channel) {
                supabaseClient.channel('new_posts')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'forum_posts', filter: `topic_id=eq.${topicId}` }, () => loadPosts())
                    .subscribe();
            }
        });

        async function loadTopicDetails() {
            const { data: topic, error } = await supabaseClient.from('forum_topics').select(`
                *,
                profiles (id, full_name, role),
                forum_categories (title)
            `).eq('id', topicId).single();

            if (error || !topic) {
                showToast("No se pudo cargar el debate.", "error");
                return;
            }

            const ranks = await fetchProfilesRanks([topic.profiles.id]);
            const userRank = ranks[topic.profiles.id] || 'Iniciado';

            const rankStyles = {
                'Oro': 'bg-amber-100 text-amber-600 border border-amber-200',
                'Plata': 'bg-slate-100 text-slate-500 border border-slate-200',
                'Bronce': 'bg-orange-50 text-orange-600 border border-orange-100',
                'Iniciado': 'bg-gray-50 text-gray-400'
            };

            document.getElementById('nav-topic-title').textContent = topic.title;
            const initials = topic.profiles?.full_name?.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || '??';
            const isDirectiva = ['super_admin', 'admin_forja'].includes(topic.profiles?.role);

            document.getElementById('topic-header').innerHTML = `
                <div class="premium-card p-10">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-full bg-[#fba931] flex items-center justify-center text-xs font-black text-[#0f172a] border-2 border-white shadow-sm">${initials}</div>
                        <div>
                            <p class="text-[10px] font-black uppercase text-slate-800 leading-none">${topic.profiles?.full_name || 'Desconocido'}</p>
                            <p class="text-[8px] font-bold text-gray-400 uppercase tracking-widest mt-1">${new Date(topic.created_at).toLocaleString('es-CL')}</p>
                        </div>
                        <div class="flex gap-2 ml-auto">
                            ${isDirectiva ? '<span class="bg-[#0f172a] text-[#fba931] text-[8px] font-black px-3 py-1 rounded-full uppercase tracking-tighter">Directiva Sede</span>' : ''}
                            <span class="${rankStyles[userRank]} text-[8px] font-black px-3 py-1 rounded-full uppercase tracking-tighter flex items-center gap-1">
                                <span class="material-symbols-outlined text-[10px]">workspace_premium</span> ${userRank}
                            </span>
                        </div>
                    </div>
                    <span class="text-[9px] font-black uppercase text-[#fba931] tracking-[0.3em] mb-2 block">${topic.forum_categories?.title}</span>
                    <h1 class="serif text-4xl text-[#0f172a] leading-tight mb-6">${topic.title}</h1>
                    <div class="prose prose-slate max-w-none text-slate-600 leading-relaxed font-medium">
                        ${topic.content.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
        }

        async function loadPosts() {
            const { data: posts, error } = await supabaseClient.from('forum_posts').select(`
                *,
                profiles (id, full_name, role)
            `).eq('topic_id', topicId).order('created_at', { ascending: true });

            if (error) return;

            const profileIds = [...new Set(posts.map(p => p.profiles.id))];
            const ranks = await fetchProfilesRanks(profileIds);

            document.getElementById('replies-count').textContent = `${posts.length} Respuestas`;

            const rankStyles = {
                'Oro': 'bg-amber-100 text-amber-600 border border-amber-200',
                'Plata': 'bg-slate-100 text-slate-500 border border-slate-200',
                'Bronce': 'bg-orange-50 text-orange-600 border border-orange-100',
                'Iniciado': 'bg-gray-50 text-gray-400'
            };

            const container = document.getElementById('posts-container');
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 opacity-40">
                        <span class="material-symbols-outlined text-4xl mb-2">comments_disabled</span>
                        <p class="text-[10px] font-black uppercase tracking-widest">A칰n no hay respuestas en este debate.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = posts.map(post => {
                const initials = post.profiles?.full_name?.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || '??';
                const isDirectiva = ['super_admin', 'admin_forja'].includes(post.profiles?.role);
                const isMe = userProfile && post.profile_id === userProfile.id;
                const userRank = ranks[post.profiles.id] || 'Iniciado';

                return `
                    <article class="reply-card p-6 ${isMe ? 'bg-slate-50/50' : ''}">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-[10px] font-black text-slate-600">${initials}</div>
                            <div class="flex flex-col">
                                <span class="text-[10px] font-black uppercase text-slate-800">${post.profiles?.full_name || 'Desconocido'}</span>
                                <span class="text-[8px] font-bold text-gray-400 uppercase tracking-widest">${new Date(post.created_at).toLocaleString('es-CL')}</span>
                            </div>
                            <div class="flex gap-2 ml-auto">
                                ${isDirectiva ? '<span class="bg-amber-50 text-amber-600 text-[8px] font-black px-2 py-0.5 rounded uppercase tracking-tighter">Directiva</span>' : ''}
                                <span class="${rankStyles[userRank]} text-[8px] font-black px-2 py-0.5 rounded uppercase tracking-tighter flex items-center gap-1">
                                    <span class="material-symbols-outlined text-[10px]">workspace_premium</span> ${userRank}
                                </span>
                            </div>
                        </div>
                        <div class="text-sm text-slate-700 leading-relaxed pl-11">
                            ${post.content.replace(/\n/g, '<br>')}
                        </div>
                    </article>
                `;
            }).join('');
        }

        async function fetchProfilesRanks(ids) {
            if (!ids || ids.length === 0) return {};
            const { data: coursesData } = await supabaseClient.from('courses').select('id, lessons(id)').eq('status', 'published');
            const courseLessonsCount = {};
            coursesData?.forEach(c => courseLessonsCount[c.id] = c.lessons.length);

            const { data: progress } = await supabaseClient.from('user_progress').select('profile_id, lesson_id, lessons(course_id)').in('profile_id', ids);
            const userStats = {};
            ids.forEach(id => userStats[id] = {});
            progress?.forEach(p => {
                const courseId = p.lessons?.course_id;
                if (courseId) {
                    if (!userStats[p.profile_id][courseId]) userStats[p.profile_id][courseId] = new Set();
                    userStats[p.profile_id][courseId].add(p.lesson_id);
                }
            });

            const userRanks = {};
            ids.forEach(id => {
                let completed = 0;
                Object.keys(userStats[id]).forEach(cId => {
                    if (userStats[id][cId].size >= (courseLessonsCount[cId] || 999)) completed++;
                });
                if (completed >= 5) userRanks[id] = 'Oro';
                else if (completed >= 3) userRanks[id] = 'Plata';
                else if (completed >= 1) userRanks[id] = 'Bronce';
                else userRanks[id] = 'Iniciado';
            });
            return userRanks;
        }

        document.getElementById('reply-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const content = document.getElementById('reply-content').value.trim();

            if (!content) return;

            btn.disabled = true;
            btn.innerHTML = "Enviando...";

            const { error } = await supabaseClient.from('forum_posts').insert([
                { topic_id: topicId, profile_id: userProfile.id, content: content }
            ]);

            if (error) {
                showToast(error.message, 'error');
            } else {
                showToast("Respuesta enviada correctamente.", 'success');
                document.getElementById('reply-content').value = '';
                await loadPosts();
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }
            btn.disabled = false;
            btn.innerHTML = '<span class="material-symbols-outlined text-lg">send</span> Enviar Respuesta';
        };
    </script>
</body>

</html>