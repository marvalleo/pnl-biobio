<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foros Regionales - Forja Libertaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        :root {
            --pnl-blue: #0f172a;
            --pnl-gold: #fba931;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f8fafc;
            color: var(--pnl-blue);
        }

        .serif {
            font-family: 'Playfair Display', serif;
        }

        .premium-card {
            background: #ffffff;
            border-radius: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.03);
            border: 1px solid #f1f5f9;
        }

        .nav-link-active {
            background: #0f172a;
            color: white;
        }

        .upvote-btn:hover {
            color: #fba931;
        }

        .downvote-btn:hover {
            color: #ef4444;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">
    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b-4 border-[#fba931] shrink-0">
        <div class="max-w-[1600px] mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-6">
                <a href="index.html">
                    <img src="wp-content/uploads/2026/pnl-del-biobio01.png" alt="PNL Biob√≠o" class="h-12">
                </a>
                <div class="h-8 w-[1px] bg-gray-100 hidden md:block"></div>
                <div class="hidden md:flex flex-col">
                    <span
                        class="text-[9px] font-black uppercase text-[#fba931] leading-none mb-1 tracking-widest">Soberan√≠a
                        Digital</span>
                    <span class="font-black text-lg uppercase leading-none tracking-tighter">Foros Regionales</span>
                </div>
            </div>

            <div class="flex items-center gap-4 lg:gap-8">
                <a href="forja-academia.html" class="nav-link text-gray-400">Academia</a>
                <a href="forja-eventos.html" class="nav-link text-gray-400">Eventos</a>
                <a href="forja-votaciones.html" class="nav-link text-gray-400">Votaciones</a>
                <a href="forja-foros.html" class="nav-link active">Foros</a>

                <div id="admin-link-container" class="hidden">
                    <a href="admin-dashboard.html"
                        class="text-[9px] font-black uppercase bg-[#0f172a] text-white px-3 py-2 rounded-lg hover:bg-black transition-colors flex items-center gap-1.5">
                        <span class="material-symbols-outlined text-sm">admin_panel_settings</span> Admin
                    </a>
                </div>
                <div id="user-menu-container" class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gray-100 animate-pulse"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- App Layout -->
    <div class="flex flex-1 overflow-hidden max-w-[1600px] mx-auto w-full">

        <!-- Sidebar -->
        <aside class="w-72 bg-white border-r border-gray-100 overflow-y-auto hidden md:block p-6">
            <div class="mb-10">
                <button onclick="openNewTopicModal()"
                    class="w-full bg-[#0f172a] text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl hover:scale-[1.02] transition-all flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-lg">add_circle</span> Nuevo Hilo
                </button>
            </div>

            <div class="space-y-8">
                <div>
                    <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-4 px-4">Canales</h3>
                    <div id="categories-list" class="space-y-1">
                        <!-- Categor√≠as din√°micas -->
                        <div class="animate-pulse space-y-2 px-4">
                            <div class="h-8 bg-gray-50 rounded-xl"></div>
                            <div class="h-8 bg-gray-50 rounded-xl"></div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Feed -->
        <main class="flex-1 overflow-y-auto bg-[#f8fafc] p-6 lg:p-10">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-8">
                    <h2 id="current-category-title" class="serif text-3xl text-[#0f172a] uppercase italic">Debate <span
                            class="text-[#fba931]">General</span></h2>
                    <div class="flex gap-2">
                        <button
                            class="bg-white border border-gray-200 px-4 py-2 rounded-full text-[10px] font-black uppercase text-gray-400 hover:border-[#fba931] transition-all">Recientes</button>
                        <button
                            class="bg-white border border-[#fba931] px-4 py-2 rounded-full text-[10px] font-black uppercase text-[#fba931]">Populares</button>
                    </div>
                </div>

                <div id="topics-feed" class="space-y-6">
                    <!-- Hilos din√°micos -->
                    <div class="animate-pulse space-y-4">
                        <div class="h-48 bg-white rounded-[2rem]"></div>
                        <div class="h-48 bg-white rounded-[2rem]"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Sidebar Trends -->
        <aside class="w-80 bg-white border-l border-gray-100 overflow-y-auto hidden xl:block p-8">
            <div class="space-y-10">
                <!-- Muro de Honor -->
                <div>
                    <h3
                        class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] mb-6 flex items-center gap-2">
                        <span class="material-symbols-outlined text-amber-500 text-lg">workspace_premium</span> Muro de
                        Honor
                    </h3>
                    <div id="honor-wall" class="space-y-4">
                        <!-- Cargando... -->
                        <div class="animate-pulse space-y-3">
                            <div class="h-12 bg-gray-50 rounded-xl"></div>
                            <div class="h-12 bg-gray-50 rounded-xl"></div>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas Sede -->
                <div class="premium-card p-6 bg-slate-50 border-none">
                    <h3 class="text-[10px] font-black text-[#0f172a] uppercase tracking-widest mb-4">Sede en Vivo</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-bold text-gray-400 uppercase">Debates Activos</span>
                            <span id="stat-topics" class="text-xs font-black text-[#0f172a]">--</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-bold text-gray-400 uppercase">Participaci√≥n</span>
                            <span id="stat-posts" class="text-xs font-black text-[#0f172a]">--</span>
                        </div>
                        <div class="w-full bg-gray-200 h-1 rounded-full overflow-hidden">
                            <div class="bg-[#fba931] h-full w-2/3"></div>
                        </div>
                        <p class="text-[8px] font-bold text-gray-400 uppercase tracking-tighter">Alta actividad
                            democratica hoy</p>
                    </div>
                </div>

                <!-- Espacio de Anuncios -->
                <div class="rounded-3xl bg-[#0f172a] p-8 relative overflow-hidden group">
                    <div
                        class="absolute -right-4 -top-4 w-24 h-24 bg-[#fba931]/20 rounded-full blur-2xl group-hover:bg-[#fba931]/40 transition-all">
                    </div>
                    <p class="text-[9px] font-black uppercase text-[#fba931] mb-2 tracking-widest relative z-10">Pr√≥ximo
                        Evento</p>
                    <h4 class="text-white font-black text-sm uppercase leading-tight mb-4 relative z-10">Plenario
                        Regional de Formaci√≥n</h4>
                    <button
                        class="w-full bg-white/10 hover:bg-white/20 text-white text-[9px] font-black uppercase py-3 rounded-xl transition-all relative z-10 tracking-widest">Ver
                        Detalles</button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Modal Nuevo Hilo -->
    <div id="new-topic-modal"
        class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] flex items-center justify-center p-6">
        <div class="bg-white rounded-[2.5rem] w-full max-w-2xl p-10 relative shadow-2xl">
            <button onclick="closeNewTopicModal()"
                class="absolute top-8 right-8 text-gray-400 hover:text-red-500 transition-colors">
                <span class="material-symbols-outlined text-3xl">close</span>
            </button>

            <h2 class="serif text-3xl text-[#0f172a] uppercase italic mb-8">Abrir nuevo <span
                    class="text-[#fba931]">Debate</span></h2>

            <form id="topic-form" class="space-y-6">
                <div>
                    <label
                        class="text-[10px] font-black uppercase text-gray-400 tracking-widest block mb-2 px-2">Categor√≠a</label>
                    <select id="form-category" required
                        class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 text-xs font-bold text-[#0f172a] focus:ring-2 focus:ring-[#fba931]/50 outline-none">
                        <!-- Categor√≠as din√°micas -->
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 tracking-widest block mb-2 px-2">T√≠tulo
                        del Debate</label>
                    <input type="text" id="form-title" required placeholder="¬øSobre qu√© quieres hablar?"
                        class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 text-xs font-bold text-[#0f172a] focus:ring-2 focus:ring-[#fba931]/50 outline-none">
                </div>
                <div>
                    <label
                        class="text-[10px] font-black uppercase text-gray-400 tracking-widest block mb-2 px-2">Argumento
                        / Contexto</label>
                    <textarea id="form-content" required rows="6" placeholder="Desarrolla tu idea con respeto..."
                        class="w-full bg-slate-50 border-none rounded-2xl px-6 py-4 text-xs font-bold text-[#0f172a] focus:ring-2 focus:ring-[#fba931]/50 outline-none resize-none"></textarea>
                </div>

                <div class="pt-4">
                    <button type="submit"
                        class="w-full bg-[#0f172a] text-white py-5 rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-xl hover:scale-[1.02] transition-all flex items-center justify-center gap-3">
                        <span class="material-symbols-outlined">rocket_launch</span> Publicar Hilo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="shared.js"></script>
    <script>
        let categories = [];
        let currentCategoryId = null;
        let userProfile = null;

        window.addEventListener('DOMContentLoaded', async () => {
            // Esperar a que Supabase se inicialice (m√°ximo 6 segundos)
            let attempts = 0;
            while (!window.isSupabaseInit && attempts < 60) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
            }

            if (!window.isSupabaseInit) {
                showToast("Conexi√≥n lenta: Intentando reconectar...", "warning");
                console.warn("Timeout de inicializaci√≥n de Supabase en forja-foros.");
                // Dar un margen extra antes de rendirse
                await new Promise(r => setTimeout(r, 2000));
                if (!window.isSupabaseInit) return;
            }

            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) { window.location.href = 'forja-login.html'; return; }

            // Cargar perfil
            const { data: profile } = await supabaseClient.from('profiles').select('*').eq('auth_id', user.id).single();
            userProfile = profile;

            if (typeof initNavbar === 'function') initNavbar();
            await loadCategories();
            await loadTopics();
            await loadHonorWall();
            await loadForumStats();
            listenToVotes();
        });

        async function loadForumStats() {
            const [topicsRes, postsRes] = await Promise.all([
                supabaseClient.from('forum_topics').select('id', { count: 'exact' }),
                supabaseClient.from('forum_posts').select('id', { count: 'exact' })
            ]);
            document.getElementById('stat-topics').textContent = topicsRes.count || 0;
            document.getElementById('stat-posts').textContent = postsRes.count || 0;
        }

        async function loadHonorWall() {
            // Obtener todos los perfiles que han publicado algo para calcular sus rangos
            const { data: activeProfiles } = await supabaseClient.from('profiles').select('id, full_name, role').limit(50);
            const profileIds = activeProfiles.map(p => p.id);
            const ranks = await fetchProfilesRanks(profileIds);

            const honorContainer = document.getElementById('honor-wall');

            // Filtrar solo a los que tienen rango Oro o Plata para el muro
            const topUsers = activeProfiles
                .map(p => ({ ...p, rank: ranks[p.id] }))
                .filter(u => ['Oro', 'Plata'].includes(u.rank))
                .sort((a, b) => (a.rank === 'Oro' ? -1 : 1))
                .slice(0, 5);

            if (topUsers.length === 0) {
                honorContainer.innerHTML = '<p class="text-[8px] font-bold text-gray-300 uppercase italic">Form√°ndonos para el muro...</p>';
                return;
            }

            honorContainer.innerHTML = topUsers.map(u => `
                <div class="flex items-center gap-3 p-3 rounded-2xl hover:bg-slate-50 transition-all border border-transparent hover:border-slate-100">
                    <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-[10px] font-black text-slate-800 border-2 border-white shadow-sm">
                        ${u.full_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()}
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] font-black text-[#0f172a] leading-none mb-1">${u.full_name}</span>
                        <span class="text-[8px] font-bold text-amber-600 uppercase tracking-widest">${u.rank}</span>
                    </div>
                    <span class="material-symbols-outlined ml-auto text-amber-400 text-lg">verified</span>
                </div>
            `).join('');
        }

        async function loadCategories() {
            const { data } = await supabaseClient.from('forum_categories').select('*').order('display_order', { ascending: true });
            categories = data || [];

            const list = document.getElementById('categories-list');
            const select = document.getElementById('form-category');

            list.innerHTML = categories.map(cat => `
                <button onclick="selectCategory('${cat.id}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${currentCategoryId === cat.id ? 'nav-link-active' : 'text-gray-500 hover:bg-gray-50 font-bold'}">
                    <span class="material-symbols-outlined text-xl">${cat.icon}</span>
                    <span class="text-xs font-bold uppercase tracking-tight">${cat.title}</span>
                </button>
            `).join('');

            select.innerHTML = categories.map(cat => `<option value="${cat.id}">${cat.title}</option>`).join('');
        }

        async function loadTopics() {
            let query = supabaseClient.from('forum_topics').select(`
                id, title, content, created_at, last_activity, category_id,
                profiles:profile_id (id, full_name, role),
                forum_votes (vote_type)
            `).order('last_activity', { ascending: false });

            if (currentCategoryId) query = query.eq('category_id', currentCategoryId);

            const { data, error } = await query;
            if (error) {
                console.error("Error al cargar t√≥picos:", error);
                showToast("Error al obtener debates.", "error");
                return;
            }

            console.log("üîç Datos de debates recibidos:", data);

            // Optimizador de Rangos: Obtener progreso de todos los autores de forma segura
            const profileIds = [...new Set(data.map(t => t.profiles?.id).filter(id => !!id))];
            const ranks = await fetchProfilesRanks(profileIds);

            const feed = document.getElementById('topics-feed');
            if (!data || data.length === 0) {
                feed.innerHTML = `
                    <div class="premium-card p-20 text-center border-dashed border-2">
                        <span class="material-symbols-outlined text-5xl text-gray-200 mb-4">move_to_inbox</span>
                        <p class="text-gray-400 font-bold uppercase text-[10px] tracking-widest">No hay debates en esta categor√≠a todav√≠a.</p>
                    </div>
                `;
                return;
            }

            feed.innerHTML = data.map(t => {
                const tid = t.id || t['id'];
                if (!tid) {
                    console.error("‚ö†Ô∏è Topic sin ID detectado:", t);
                    return '';
                }

                const voteCount = (t.forum_votes || []).reduce((acc, v) => acc + v.vote_type, 0);
                const initials = t.profiles?.full_name?.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || '??';
                const isDirectiva = ['super_admin', 'admin_forja'].includes(t.profiles?.role);
                const userRank = (t.profiles?.id && ranks[t.profiles.id]) ? ranks[t.profiles.id] : 'Iniciado';

                const rankStyles = {
                    'Oro': 'bg-amber-100 text-amber-600 border border-amber-200',
                    'Plata': 'bg-slate-100 text-slate-500 border border-slate-200',
                    'Bronce': 'bg-orange-50 text-orange-600 border border-orange-100',
                    'Iniciado': 'bg-gray-50 text-gray-400'
                };

                const postUrl = `forja-foros-post.html?id=${tid}`;
                console.log(`üîó Generando link para "${t.title}": ${postUrl}`);

                return `
                    <article class="premium-card p-8 flex gap-6 hover:shadow-2xl transition-all group">
                        <div class="flex flex-col items-center gap-1 shrink-0">
                            <button onclick="vote('${tid}', 1)" class="material-symbols-outlined upvote-btn text-gray-300 transition-colors">arrow_drop_up</button>
                            <span class="text-sm font-black text-[#0f172a]">${voteCount}</span>
                            <button onclick="vote('${tid}', -1)" class="material-symbols-outlined downvote-btn text-gray-300 transition-colors">arrow_drop_down</button>
                        </div>
                        
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-[10px] font-black text-slate-800">${initials}</div>
                                <span class="text-[10px] font-black uppercase text-slate-800">${t.profiles?.full_name || 'Desconocido'}</span>
                                <span class="w-1.5 h-1.5 rounded-full bg-gray-200"></span>
                                <span class="text-[10px] font-bold text-gray-400 uppercase">${new Date(t.created_at).toLocaleDateString()}</span>
                                
                                <div class="flex gap-2 ml-auto">
                                    ${isDirectiva ? '<span class="bg-[#0f172a] text-[#fba931] text-[8px] font-black px-2 py-0.5 rounded uppercase tracking-tighter">Directiva</span>' : ''}
                                    <span class="${rankStyles[userRank]} text-[8px] font-black px-3 py-1 rounded-full uppercase tracking-tighter flex items-center gap-1">
                                        <span class="material-symbols-outlined text-[10px]">workspace_premium</span> ${userRank}
                                    </span>
                                </div>
                            </div>
                            <a href="${postUrl}" onclick="sessionStorage.setItem('current_topic_id', '${tid}')" class="block group">
                                <h3 class="text-xl font-800 text-[#0f172a] mb-4 group-hover:text-[#fba931] transition-colors leading-tight cursor-pointer">
                                    ${t.title}
                                </h3>
                            </a>
                            <p class="text-sm text-slate-500 leading-relaxed mb-6 line-clamp-3">${t.content}</p>
                            <div class="flex items-center gap-6">
                                <a href="${postUrl}" onclick="sessionStorage.setItem('current_topic_id', '${tid}')" class="flex items-center gap-2 text-gray-400 hover:text-[#fba931] transition-colors">
                                    <span class="material-symbols-outlined text-lg">chat_bubble</span>
                                    <span class="text-[10px] font-black uppercase tracking-widest cursor-pointer">Ver Debate</span>
                                </a>
                            </div>
                        </div>
                    </article>
                `;
            }).join('');
        }

        async function fetchProfilesRanks(ids) {
            if (!ids || ids.length === 0) return {};

            // 1. Obtener lecciones totales por curso
            const { data: coursesData } = await supabaseClient.from('courses').select('id, lessons(id)').eq('status', 'published');
            const courseLessonsCount = {};
            coursesData?.forEach(c => courseLessonsCount[c.id] = c.lessons.length);

            // 2. Obtener progreso de todos los usuarios
            const { data: progress } = await supabaseClient
                .from('user_progress')
                .select('profile_id, lesson_id, lessons(course_id)')
                .in('profile_id', ids);

            const userStats = {};
            ids.forEach(id => userStats[id] = new Set());

            progress?.forEach(p => {
                const courseId = p.lessons?.course_id;
                if (courseId) {
                    if (!userStats[p.profile_id]) userStats[p.profile_id] = {};
                    if (!userStats[p.profile_id][courseId]) userStats[p.profile_id][courseId] = new Set();
                    userStats[p.profile_id][courseId].add(p.lesson_id);
                }
            });

            const userRanks = {};
            ids.forEach(id => {
                let completedCourses = 0;
                const stats = userStats[id];
                if (stats && typeof stats === 'object') {
                    Object.keys(stats).forEach(cId => {
                        if (stats[cId].size >= (courseLessonsCount[cId] || 999)) {
                            completedCourses++;
                        }
                    });
                }

                if (completedCourses >= 5) userRanks[id] = 'Oro';
                else if (completedCourses >= 3) userRanks[id] = 'Plata';
                else if (completedCourses >= 1) userRanks[id] = 'Bronce';
                else userRanks[id] = 'Iniciado';
            });

            return userRanks;
        }

        async function vote(topicId, type) {
            try {
                // Upsert vote
                const { error } = await supabaseClient.from('forum_votes').upsert([
                    { topic_id: topicId, profile_id: userProfile.id, vote_type: type }
                ]);
                if (error) throw error;
                await loadTopics(); // Recargar para ver cambios
            } catch (err) {
                showToast("Error al votar: " + err.message, 'error');
            }
        }

        function selectCategory(id) {
            currentCategoryId = id;
            const cat = categories.find(c => c.id === id);
            document.getElementById('current-category-title').innerHTML = cat.title.replace(' ', ' <span class="text-[#fba931]">') + '</span>';
            loadCategories();
            loadTopics();
        }

        function openNewTopicModal() { document.getElementById('new-topic-modal').classList.remove('hidden'); }
        function closeNewTopicModal() { document.getElementById('new-topic-modal').classList.add('hidden'); }

        document.getElementById('topic-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = "Publicando...";

            const topicData = {
                category_id: document.getElementById('form-category').value,
                title: document.getElementById('form-title').value,
                content: document.getElementById('form-content').value,
                profile_id: userProfile.id
            };

            const { error } = await supabaseClient.from('forum_topics').insert([topicData]);

            if (error) {
                showToast(error.message, 'error');
            } else {
                showToast("¬°Hilo publicado exitosamente!", 'success');
                closeNewTopicModal();
                e.target.reset();
                await loadTopics();
            }
            btn.disabled = false;
            btn.innerHTML = '<span class="material-symbols-outlined">rocket_launch</span> Publicar Hilo';
        };

        function listenToVotes() {
            supabaseClient.channel('forum_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'forum_votes' }, () => loadTopics())
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'forum_topics' }, () => loadTopics())
                .subscribe();
        }
    </script>
</body>

</html>