<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual - Forja Libertaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        :root {
            --pnl-blue: #0f172a;
            --pnl-gold: #fba931;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #0f172a;
            color: white;
        }

        .serif {
            font-family: 'Playfair Display', serif;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .card-gradient {
            background: linear-gradient(180deg, rgba(15, 23, 42, 0) 0%, rgba(15, 23, 42, 0.9) 100%);
        }

        .heartbeat-dot {
            width: 8px;
            height: 8px;
            background: #fba931;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 10px #fba931;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(251, 169, 49, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(251, 169, 49, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(251, 169, 49, 0);
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Sidebar Lecciones -->
    <aside class="w-full md:w-96 bg-white border-r border-gray-200 flex flex-col h-full z-10 shadow-xl overflow-hidden">
        <div class="p-6 border-b border-gray-100 flex items-center gap-4">
            <a href="forja-academia.html"
                class="hover:bg-gray-100 p-2 rounded-full transition-colors flex items-center justify-center">
                <span class="material-symbols-outlined text-[#0f172a]">arrow_back</span>
            </a>
            <div class="overflow-hidden">
                <h1 id="course-title" class="font-900 uppercase text-sm leading-tight text-[#0f172a] truncate">Cargando
                    curso...</h1>
                <div class="w-full bg-gray-100 h-1.5 rounded-full mt-2">
                    <div id="progress-bar" class="bg-[#fba931] h-full w-0 transition-all duration-1000"></div>
                </div>
                <div class="flex justify-between items-center mt-1">
                    <p id="course-progress-text" class="text-[9px] font-black text-[#fba931] uppercase tracking-widest">
                        0% Completado</p>
                    <div id="attendance-tracking" class="hidden items-center gap-1">
                        <span class="heartbeat-dot"></span>
                        <span id="attendance-time" class="text-[8px] font-black text-gray-400">0 min</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="lessons-list" class="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-hide">
            <div class="p-8 text-center text-gray-400">
                <div class="animate-spin h-6 w-6 border-2 border-gray-200 border-t-[#fba931] rounded-full mx-auto mb-4">
                </div>
                <p class="text-[10px] uppercase font-bold">Sincronizando Malla...</p>
            </div>
        </div>
    </aside>

    <!-- √Årea de Contenido -->
    <main class="flex-1 flex flex-col relative bg-[#1e293b]">

        <!-- Pantalla de Bienvenida / No Video -->
        <div id="placeholder-overlay" class="flex-1 flex flex-col items-center justify-center p-8 text-center">
            <div
                class="w-24 h-24 bg-[#fba931]/10 border border-[#fba931]/30 rounded-full flex items-center justify-center mb-8 shadow-[0_0_50px_rgba(251,169,49,0.1)]">
                <span class="material-symbols-outlined text-5xl text-[#fba931]">school</span>
            </div>
            <h2 class="serif text-3xl text-[#fba931]">Comienza tu formaci√≥n</h2>
            <p id="course-desc-ui" class="text-gray-400 text-sm mt-4 uppercase font-bold tracking-widest max-w-sm">
                Selecciona una lecci√≥n del men√∫.</p>
        </div>

        <!-- Reproductor de Video -->
        <div id="video-wrapper" class="hidden flex-1 flex flex-col">
            <div class="bg-black flex-1 relative flex items-center justify-center">
                <iframe id="video-player" class="w-full h-full" src="" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>
            </div>
        </div>

        <!-- Vista de Sesi√≥n Live / Presencial -->
        <div id="session-wrapper" class="hidden flex-1 flex flex-col items-center justify-center p-8">
            <div id="session-card"
                class="bg-[#0f172a] p-12 rounded-[3rem] border border-white/10 shadow-2xl max-w-2xl w-full text-center">
                <span id="session-badge"
                    class="px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest mb-6 inline-block">--</span>
                <h2 id="session-title-large" class="serif text-4xl text-[#fba931] mb-2">--</h2>
                <p id="session-desc" class="text-gray-400 text-xs font-medium mb-8 max-w-md mx-auto line-clamp-3">--</p>

                <div
                    class="flex flex-col items-center gap-4 text-gray-300 mb-8 bg-white/5 p-6 rounded-3xl border border-white/5">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm text-[#fba931]">event</span>
                            <span id="session-date" class="text-[10px] font-black uppercase tracking-widest">--</span>
                        </div>
                        <div id="session-loc-container" class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm text-[#fba931]">location_on</span>
                            <span id="session-location"
                                class="text-[10px] font-black uppercase tracking-widest">--</span>
                        </div>
                    </div>
                    <div id="session-capacity-info"
                        class="text-[10px] font-black uppercase tracking-[0.2em] text-[#fba931]">
                        Cupos Disponibles: <span id="capacity-count">--</span>
                    </div>
                </div>

                <div id="session-actions" class="flex gap-4 justify-center">
                    <button id="btn-register" onclick="registerToEvent()"
                        class="bg-[#fba931] text-[#0f172a] px-10 py-4 rounded-2xl font-900 text-xs uppercase tracking-widest hover:scale-105 transition-transform">Inscribirse
                        ahora</button>

                    <a id="session-action-link" target="_blank"
                        class="hidden bg-[#fba931] text-[#0f172a] px-10 py-4 rounded-2xl font-900 text-xs uppercase tracking-widest hover:scale-105 transition-transform">Ir
                        a la sesi√≥n</a>

                    <button id="session-map-btn" onclick="openMap()"
                        class="bg-white/5 border border-white/10 text-white px-10 py-4 rounded-2xl font-900 text-xs uppercase tracking-widest hover:bg-white/10 transition-colors hidden">Ver
                        Mapa</button>
                </div>

                <p id="registration-status"
                    class="mt-4 text-[9px] font-black uppercase text-green-500 tracking-widest hidden">¬°Ya est√°s
                    inscrito!</p>
            </div>
        </div>

        <!-- Info Footer -->
        <div id="lesson-footer"
            class="hidden bg-white p-8 border-t border-gray-100 shadow-[0_-10px_40px_rgba(0,0,0,0.3)]">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                <div>
                    <div class="flex items-center gap-3">
                        <span id="lesson-order-badge"
                            class="text-[10px] font-black text-[#fba931] uppercase tracking-[0.2em]">01</span>
                        <span id="delivery-badge"
                            class="text-[8px] font-black bg-gray-100 text-gray-500 px-2 py-0.5 rounded uppercase">Grabado</span>
                    </div>
                    <h2 id="lesson-title-footer"
                        class="text-2xl font-900 uppercase mt-1 tracking-tighter text-[#0f172a]">Introducci√≥n</h2>
                    <p id="lesson-desc-footer" class="text-xs text-gray-400 font-medium mt-1">--</p>
                </div>
                <div class="flex gap-4 w-full md:w-auto">
                    <button onclick="toggleCompletion()" id="btn-complete"
                        class="flex-1 md:flex-none bg-gray-100 text-gray-400 px-8 py-4 rounded-2xl font-900 text-xs uppercase tracking-widest hover:brightness-95 transition-all flex items-center justify-center gap-3 active:scale-95">
                        <span class="material-symbols-outlined text-xl">check_circle</span>
                        <span id="btn-text">Marcar como Visto</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="shared.js"></script>
    <script>
        let currentLessons = [];
        let completedLessonIds = new Set();
        let registrations = new Set();
        let currentLessonIndex = -1;
        let profileId = null;
        let currentCourseId = localStorage.getItem('current_course_id');
        let heartbeatInterval = null;

        window.addEventListener('DOMContentLoaded', async () => {
            if (!window.supabaseClient) {
                showToast("Error de inicializaci√≥n del aula virtual.", "error");
                return;
            }

            if (!currentCourseId) {
                window.location.href = 'forja-academia.html';
                return;
            }

            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) { window.location.href = 'forja-login.html'; return; }

            // Usar cache de sesi√≥n si existe
            let profile = JSON.parse(sessionStorage.getItem('pnl_profile'));
            if (!profile) {
                const { data } = await supabaseClient.from('profiles').select('id, role').eq('auth_id', user.id).single();
                profile = data;
                if (profile) sessionStorage.setItem('pnl_profile', JSON.stringify(profile));
            }

            if (!profile) {
                showToast("Error: Perfil no encontrado.", 'error');
                return;
            }
            profileId = profile.id;

            await Promise.all([loadCourse(), loadLessons(), loadRegistrations()]);
        });

        async function loadCourse() {
            const { data } = await supabaseClient.from('courses').select('*').eq('id', currentCourseId).single();
            if (data) {
                document.getElementById('course-title').textContent = data.title;
                document.getElementById('course-desc-ui').textContent = data.description || 'Selecciona una lecci√≥n del men√∫ para visualizar el contenido.';
            }
        }

        async function loadRegistrations() {
            const { data } = await supabaseClient.from('lesson_registrations').select('lesson_id').eq('profile_id', profileId);
            registrations = new Set(data.map(r => r.lesson_id));
        }

        async function loadLessons() {
            try {
                const { data: lessons, error } = await supabaseClient
                    .from('lessons')
                    .select('*')
                    .eq('course_id', currentCourseId)
                    .order('order', { ascending: true });

                if (error) throw error;
                currentLessons = lessons || [];

                const { data: progress } = await supabaseClient
                    .from('user_progress')
                    .select('lesson_id, minutes_watched')
                    .eq('profile_id', profileId);

                // Store minutes watched for the heartbeat
                window.lessonProgressMap = {};
                progress.forEach(p => {
                    window.lessonProgressMap[p.lesson_id] = p.minutes_watched || 0;
                });

                completedLessonIds = new Set(progress.map(p => p.lesson_id));

                renderLessons();
                updateProgress();
            } catch (err) { console.error(err); }
        }

        function renderLessons() {
            const container = document.getElementById('lessons-list');
            if (currentLessons.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-10 text-[10px] uppercase font-black">Sin contenido disponible.</p>';
                return;
            }

            container.innerHTML = currentLessons.map((lesson, index) => {
                const isCompleted = completedLessonIds.has(lesson.id);
                const isActive = index === currentLessonIndex;

                return `
                    <div onclick="selectLesson(${index})" 
                         class="cursor-pointer p-4 rounded-2xl transition-all border-2 ${isActive ? 'bg-blue-50 border-[#fba931]' : 'bg-white border-transparent hover:border-blue-50 group'}">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-lg ${isCompleted ? 'text-green-500' : 'text-gray-200'}">
                                ${isCompleted ? 'check_circle' : 'radio_button_unchecked'}
                            </span>
                            <div class="flex-1 overflow-hidden">
                                <p class="text-[8px] font-black ${isActive ? 'text-[#fba931]' : 'text-gray-300'} uppercase tracking-[0.2em] mb-0.5">Lecci√≥n ${lesson.order}</p>
                                <h3 class="font-800 text-[11px] uppercase leading-tight truncate transition-colors ${isActive ? 'text-[#0f172a]' : 'text-gray-500 group-hover:text-[#0f172a]'}">
                                    ${lesson.title}
                                </h3>
                                <div class="flex gap-3 mt-1">
                                    <span class="text-[7px] font-black text-gray-300 uppercase">${lesson.delivery_type === 'recorded' ? 'üé•' : lesson.delivery_type === 'live' ? 'üì°' : 'üèõÔ∏è'}</span>
                                    <span class="text-[7px] font-black text-gray-300 uppercase">${lesson.duration || '--'}</span>
                                    ${window.lessonProgressMap && window.lessonProgressMap[lesson.id] > 0 ? `<span class="text-[7px] font-black text-[#fba931] uppercase">${window.lessonProgressMap[lesson.id]} min</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateProgress() {
            const percent = Math.round((completedLessonIds.size / currentLessons.length) * 100) || 0;
            const bar = document.getElementById('progress-bar');
            if (bar) bar.style.width = `${percent}%`;
            const text = document.getElementById('course-progress-text');
            if (text) text.textContent = `${percent}% Completado`;
        }

        async function selectLesson(index) {
            currentLessonIndex = index;
            const lesson = currentLessons[index];
            const isCompleted = completedLessonIds.has(lesson.id);

            // UI Resets
            document.getElementById('placeholder-overlay').classList.add('hidden');
            document.getElementById('video-wrapper').classList.add('hidden');
            document.getElementById('session-wrapper').classList.add('hidden');
            document.getElementById('lesson-footer').classList.remove('hidden');

            // Footer
            document.getElementById('lesson-order-badge').textContent = lesson.order.toString().padStart(2, '0');
            document.getElementById('lesson-title-footer').textContent = lesson.title;
            document.getElementById('lesson-desc-footer').textContent = lesson.description || 'Sin descripci√≥n adicional.';
            const deliveryLabels = { recorded: 'Grabado', live: 'En Vivo', in_person: 'Presencial' };
            document.getElementById('delivery-badge').textContent = deliveryLabels[lesson.delivery_type];

            if (lesson.delivery_type === 'recorded') {
                document.getElementById('video-wrapper').classList.remove('hidden');
                document.getElementById('video-player').src = lesson.content_url;
                startAttendanceHeartbeat(lesson.id);
            } else {
                stopAttendanceHeartbeat();
                document.getElementById('session-wrapper').classList.remove('hidden');
                document.getElementById('session-title-large').textContent = lesson.title;
                document.getElementById('session-desc').textContent = lesson.description || 'Esta sesi√≥n se llevar√° a cabo seg√∫n la fecha programada.';

                const badge = document.getElementById('session-badge');
                badge.textContent = deliveryLabels[lesson.delivery_type];
                badge.className = `px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest mb-6 inline-block ${lesson.delivery_type === 'live' ? 'bg-red-600 animate-pulse' : 'bg-white text-black'}`;

                const dateStr = lesson.scheduled_at ? new Date(lesson.scheduled_at).toLocaleString('es-CL', { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' }) : 'Fecha por confirmar';
                document.getElementById('session-date').textContent = dateStr;

                const locContainer = document.getElementById('session-loc-container');
                const actionLink = document.getElementById('session-action-link');
                const regBtn = document.getElementById('btn-register');
                const mapBtn = document.getElementById('session-map-btn');
                const statusTxt = document.getElementById('registration-status');
                const capInfo = document.getElementById('session-capacity-info');

                // Capacidad
                if (lesson.max_capacity > 0) {
                    capInfo.classList.remove('hidden');
                    const { count } = await supabaseClient.from('lesson_registrations').select('*', { count: 'exact', head: true }).eq('lesson_id', lesson.id);
                    document.getElementById('capacity-count').textContent = `${count} / ${lesson.max_capacity}`;
                } else {
                    capInfo.classList.add('hidden');
                }

                if (lesson.delivery_type === 'live') {
                    locContainer.classList.add('hidden');
                    mapBtn.classList.add('hidden');
                } else {
                    locContainer.classList.remove('hidden');
                    document.getElementById('session-location').textContent = lesson.location || 'Consultar sede';
                    mapBtn.classList.remove('hidden');
                }

                // L√≥gica de Inscripci√≥n
                const isRegistered = registrations.has(lesson.id);
                if (isRegistered) {
                    regBtn.classList.add('hidden');
                    statusTxt.classList.remove('hidden');
                    if (lesson.delivery_type === 'live' && lesson.content_url) {
                        actionLink.classList.remove('hidden');
                        actionLink.href = lesson.content_url;
                    }
                    startAttendanceHeartbeat(lesson.id); // Tambi√©n trackeamos tiempo en la p√°gina de la sesi√≥n
                } else {
                    regBtn.classList.remove('hidden');
                    statusTxt.classList.add('hidden');
                    actionLink.classList.add('hidden');
                }
            }

            updateButtonUI(isCompleted);
            renderLessons();
        }

        async function registerToEvent() {
            const lesson = currentLessons[currentLessonIndex];
            try {
                const { error } = await supabaseClient.from('lesson_registrations').insert([{ profile_id: profileId, lesson_id: lesson.id }]);
                if (error) {
                    if (error.code === '23505') showToast("Ya est√°s inscrito en este evento.", 'info');
                    else throw error;
                } else {
                    showToast("¬°Te has inscrito con √©xito!", 'success');
                    registrations.add(lesson.id);
                    selectLesson(currentLessonIndex); // Refresh UI
                }
            } catch (err) { showToast("Error al inscribirse: " + err.message, 'error'); }
        }

        function startAttendanceHeartbeat(lessonId) {
            stopAttendanceHeartbeat();
            const tracking = document.getElementById('attendance-tracking');
            const timeDisplay = document.getElementById('attendance-time');
            tracking.classList.remove('flex');
            tracking.classList.add('hidden');

            let minutes = window.lessonProgressMap[lessonId] || 0;
            timeDisplay.textContent = `${minutes} min`;

            heartbeatInterval = setInterval(async () => {
                minutes++;
                timeDisplay.textContent = `${minutes} min`;
                tracking.classList.remove('hidden');
                tracking.classList.add('flex');

                window.lessonProgressMap[lessonId] = minutes;

                // Sync with DB
                try {
                    const { data: currentProg } = await supabaseClient.from('user_progress').select('id').match({ profile_id: profileId, lesson_id: lessonId }).single();
                    if (currentProg) {
                        await supabaseClient.from('user_progress').update({ minutes_watched: minutes, last_heartbeat: new Date().toISOString() }).eq('id', currentProg.id);
                    } else {
                        await supabaseClient.from('user_progress').insert([{ profile_id: profileId, lesson_id: lessonId, minutes_watched: minutes, is_completed: false }]);
                    }
                } catch (e) { console.error("Heartbeat sync error", e); }
            }, 60000); // Cada 1 minuto
        }

        function stopAttendanceHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            document.getElementById('attendance-tracking').classList.add('hidden');
        }

        function updateButtonUI(isCompleted) {
            const btn = document.getElementById('btn-complete');
            const btnText = document.getElementById('btn-text');
            if (isCompleted) {
                btn.className = "flex-1 md:flex-none bg-green-100 text-green-700 px-8 py-4 rounded-2xl font-900 text-xs uppercase tracking-widest transition-all flex items-center justify-center gap-3";
                btnText.textContent = "Completada";
            } else {
                btn.className = "flex-1 md:flex-none bg-gray-100 text-gray-400 px-8 py-4 rounded-2xl font-900 text-xs uppercase tracking-widest hover:brightness-95 transition-all flex items-center justify-center gap-3 active:scale-95";
                btnText.textContent = "Marcar como Completada";
            }
        }

        async function toggleCompletion() {
            if (currentLessonIndex === -1) return;
            const lesson = currentLessons[currentLessonIndex];
            const isCompleted = completedLessonIds.has(lesson.id);

            try {
                if (isCompleted) {
                    // Update only completion status, keep minutes
                    await supabaseClient.from('user_progress').update({ is_completed: false }).match({ profile_id: profileId, lesson_id: lesson.id });
                    completedLessonIds.delete(lesson.id);
                } else {
                    const { data: exists } = await supabaseClient.from('user_progress').select('id').match({ profile_id: profileId, lesson_id: lesson.id }).single();
                    if (exists) {
                        await supabaseClient.from('user_progress').update({ is_completed: true }).eq('id', exists.id);
                    } else {
                        await supabaseClient.from('user_progress').insert([{ profile_id: profileId, lesson_id: lesson.id, is_completed: true }]);
                    }
                    completedLessonIds.add(lesson.id);
                }
                updateButtonUI(!isCompleted);
                updateProgress();
                renderLessons();
            } catch (err) { console.error(err); }
        }

        function openMap() {
            const lesson = currentLessons[currentLessonIndex];
            if (lesson && lesson.location) {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(lesson.location)}`, '_blank');
            }
        }
    </script>
</body>

</html>