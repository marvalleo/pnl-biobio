<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual - Forja Libertaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        :root {
            --pnl-blue: #0f172a;
            --pnl-gold: #fba931;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #0f172a;
            color: white;
        }

        .serif {
            font-family: 'Playfair Display', serif;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .card-gradient {
            background: linear-gradient(180deg, rgba(15, 23, 42, 0) 0%, rgba(15, 23, 42, 0.9) 100%);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
</head>

<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Sidebar Lecciones -->
    <aside class="w-full md:w-96 bg-white border-r border-gray-200 flex flex-col h-full z-10 shadow-xl overflow-hidden">
        <div class="p-6 border-b border-gray-100 flex items-center gap-4">
            <a href="forja-academia.html"
                class="hover:bg-gray-100 p-2 rounded-full transition-colors flex items-center justify-center">
                <span class="material-symbols-outlined text-[#0f172a]">arrow_back</span>
            </a>
            <div class="overflow-hidden">
                <h1 id="course-title" class="font-900 uppercase text-sm leading-tight text-[#0f172a] truncate">Cargando
                    curso...</h1>
                <div class="w-full bg-gray-100 h-1.5 rounded-full mt-2">
                    <div id="progress-bar" class="bg-[#fba931] h-full w-0 transition-all duration-1000"></div>
                </div>
                <p id="course-progress-text"
                    class="text-[9px] font-black text-[#fba931] uppercase mt-1 tracking-widest">0% Completado</p>
            </div>
        </div>

        <div id="lessons-list" class="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-hide">
            <div class="p-8 text-center text-gray-400">
                <div class="animate-spin h-6 w-6 border-2 border-gray-200 border-t-[#fba931] rounded-full mx-auto mb-4">
                </div>
                <p class="text-[10px] uppercase font-bold">Sincronizando Malla...</p>
            </div>
        </div>
    </aside>

    <!-- √Årea de Contenido -->
    <main class="flex-1 flex flex-col relative bg-[#1e293b]">

        <!-- Pantalla de Bienvenida / No Video -->
        <div id="placeholder-overlay" class="flex-1 flex flex-col items-center justify-center p-8 text-center">
            <div
                class="w-24 h-24 bg-[#fba931]/10 border border-[#fba931]/30 rounded-full flex items-center justify-center mb-8 shadow-[0_0_50px_rgba(251,169,49,0.1)]">
                <span class="material-symbols-outlined text-5xl text-[#fba931]">school</span>
            </div>
            <h2 class="serif text-3xl text-[#fba931]">Comienza tu formaci√≥n</h2>
            <p class="text-gray-400 text-sm mt-4 uppercase font-bold tracking-widest max-w-sm">Selecciona una lecci√≥n
                del men√∫ para visualizar el contenido.</p>
        </div>

        <!-- Reproductor de Video -->
        <div id="video-wrapper" class="hidden flex-1 flex flex-col">
            <div class="bg-black flex-1 relative flex items-center justify-center">
                <iframe id="video-player" class="w-full h-full" src="" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>
            </div>
        </div>

        <!-- Vista de Sesi√≥n Live / Presencial -->
        <div id="session-wrapper" class="hidden flex-1 flex flex-col items-center justify-center p-8">
            <div id="session-card"
                class="bg-[#0f172a] p-12 rounded-[3rem] border border-white/10 shadow-2xl max-w-2xl w-full text-center">
                <span id="session-badge"
                    class="px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest mb-6 inline-block">--</span>
                <h2 id="session-title-large" class="serif text-4xl text-[#fba931] mb-4">--</h2>
                <div class="flex flex-col items-center gap-4 text-gray-400 mb-8">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">event</span>
                        <span id="session-date" class="text-xs font-bold uppercase tracking-widest">--</span>
                    </div>
                    <div id="session-loc-container" class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">location_on</span>
                        <span id="session-location" class="text-xs font-bold uppercase tracking-widest">--</span>
                    </div>
                </div>
                <div class="flex gap-4 justify-center">
                    <a id="session-action-btn" target="_blank"
                        class="bg-[#fba931] text-[#0f172a] px-10 py-4 rounded-2xl font-900 text-xs uppercase tracking-widest hover:scale-105 transition-transform cursor-pointer">Unirse
                        ahora</a>
                    <button id="session-map-btn" onclick="openMap()"
                        class="bg-white/5 border border-white/10 text-white px-10 py-4 rounded-2xl font-900 text-xs uppercase tracking-widest hover:bg-white/10 transition-colors hidden">Ver
                        Mapa</button>
                </div>
            </div>
        </div>

        <!-- Info Footer -->
        <div id="lesson-footer"
            class="hidden bg-white p-8 border-t border-gray-100 shadow-[0_-10px_40px_rgba(0,0,0,0.3)]">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                <div>
                    <div class="flex items-center gap-3">
                        <span id="lesson-order-badge"
                            class="text-[10px] font-black text-[#fba931] uppercase tracking-[0.2em]">01</span>
                        <span id="delivery-badge"
                            class="text-[8px] font-black bg-gray-100 text-gray-500 px-2 py-0.5 rounded uppercase">Grabado</span>
                    </div>
                    <h2 id="lesson-title-footer"
                        class="text-2xl font-900 uppercase mt-1 tracking-tighter text-[#0f172a]">Introducci√≥n</h2>
                </div>
                <div class="flex gap-4 w-full md:w-auto">
                    <button onclick="toggleCompletion()" id="btn-complete"
                        class="flex-1 md:flex-none bg-gray-100 text-gray-400 px-8 py-4 rounded-2xl font-900 text-xs uppercase tracking-widest hover:brightness-95 transition-all flex items-center justify-center gap-3 active:scale-95">
                        <span class="material-symbols-outlined text-xl">check_circle</span>
                        <span id="btn-text">Marcar como Visto</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentLessons = [];
        let completedLessonIds = new Set();
        let currentLessonIndex = -1;
        let profileId = null;
        let currentCourseId = localStorage.getItem('current_course_id');

        window.addEventListener('DOMContentLoaded', async () => {
            if (!currentCourseId) {
                window.location.href = 'forja-academia.html';
                return;
            }

            // 1. Obtener Perfil
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) { window.location.href = 'forja-login.html'; return; }

            const { data: profile } = await supabaseClient.from('profiles').select('id').eq('auth_id', user.id).single();
            if (!profile) { alert("Error: Perfil no encontrado."); return; }
            profileId = profile.id;

            // 2. Cargar Datos
            await Promise.all([loadCourse(), loadLessons()]);
        });

        async function loadCourse() {
            const { data } = await supabaseClient.from('courses').select('title').eq('id', currentCourseId).single();
            if (data) document.getElementById('course-title').textContent = data.title;
        }

        async function loadLessons() {
            try {
                const { data: lessons, error } = await supabaseClient
                    .from('lessons')
                    .select('*')
                    .eq('course_id', currentCourseId)
                    .order('order', { ascending: true });

                if (error) throw error;
                currentLessons = lessons || [];

                const { data: progress } = await supabaseClient
                    .from('user_progress')
                    .select('lesson_id')
                    .eq('profile_id', profileId);

                completedLessonIds = new Set(progress.map(p => p.lesson_id));

                renderLessons();
                updateProgress();
            } catch (err) { console.error(err); }
        }

        function renderLessons() {
            const container = document.getElementById('lessons-list');
            if (currentLessons.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-10 text-[10px] uppercase font-black">Sin contenido disponible.</p>';
                return;
            }

            container.innerHTML = currentLessons.map((lesson, index) => {
                const isCompleted = completedLessonIds.has(lesson.id);
                const isActive = index === currentLessonIndex;

                return `
                    <div onclick="selectLesson(${index})" 
                         class="cursor-pointer p-4 rounded-2xl transition-all border-2 ${isActive ? 'bg-blue-50 border-[#fba931]' : 'bg-white border-transparent hover:border-blue-50 group'}">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-lg ${isCompleted ? 'text-green-500' : 'text-gray-200'}">
                                ${isCompleted ? 'check_circle' : 'radio_button_unchecked'}
                            </span>
                            <div class="flex-1 overflow-hidden">
                                <p class="text-[8px] font-black ${isActive ? 'text-[#fba931]' : 'text-gray-300'} uppercase tracking-[0.2em] mb-0.5">Lecci√≥n ${lesson.order}</p>
                                <h3 class="font-800 text-[11px] uppercase leading-tight truncate transition-colors ${isActive ? 'text-[#0f172a]' : 'text-gray-500 group-hover:text-[#0f172a]'}">
                                    ${lesson.title}
                                </h3>
                                <div class="flex gap-2 mt-1">
                                    <span class="text-[7px] font-black text-gray-300 uppercase">${lesson.delivery_type === 'recorded' ? 'üé•' : lesson.delivery_type === 'live' ? 'üì°' : 'üèõÔ∏è'}</span>
                                    <span class="text-[7px] font-black text-gray-300 uppercase">${lesson.duration || '--'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateProgress() {
            const percent = Math.round((completedLessonIds.size / currentLessons.length) * 100) || 0;
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('course-progress-text').textContent = `${percent}% Completado`;
        }

        function selectLesson(index) {
            currentLessonIndex = index;
            const lesson = currentLessons[index];
            const isCompleted = completedLessonIds.has(lesson.id);

            // Hide all wrappers
            document.getElementById('placeholder-overlay').classList.add('hidden');
            document.getElementById('video-wrapper').classList.add('hidden');
            document.getElementById('session-wrapper').classList.add('hidden');
            document.getElementById('lesson-footer').classList.remove('hidden');

            // Set footer info
            document.getElementById('lesson-order-badge').textContent = lesson.order.toString().padStart(2, '0');
            document.getElementById('lesson-title-footer').textContent = lesson.title;
            const deliveryLabels = { recorded: 'Grabado', live: 'En Vivo', in_person: 'Presencial' };
            document.getElementById('delivery-badge').textContent = deliveryLabels[lesson.delivery_type];

            if (lesson.delivery_type === 'recorded') {
                document.getElementById('video-wrapper').classList.remove('hidden');
                document.getElementById('video-player').src = lesson.content_url;
            } else {
                document.getElementById('session-wrapper').classList.remove('hidden');
                document.getElementById('session-title-large').textContent = lesson.title;
                document.getElementById('session-badge').textContent = deliveryLabels[lesson.delivery_type];
                document.getElementById('session-badge').className = `px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest mb-6 inline-block ${lesson.delivery_type === 'live' ? 'bg-red-600 animate-pulse' : 'bg-white text-black'}`;

                const date = lesson.scheduled_at ? new Date(lesson.scheduled_at).toLocaleString('es-CL', { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' }) : 'Fecha por confirmar';
                document.getElementById('session-date').textContent = date;

                const locContainer = document.getElementById('session-loc-container');
                const locText = document.getElementById('session-location');
                const actionBtn = document.getElementById('session-action-btn');
                const mapBtn = document.getElementById('session-map-btn');

                if (lesson.delivery_type === 'live') {
                    locContainer.classList.add('hidden');
                    mapBtn.classList.add('hidden');
                    actionBtn.textContent = "Unirse a la Sesi√≥n (Zoom/Meet)";
                    actionBtn.href = lesson.content_url;
                } else {
                    locContainer.classList.remove('hidden');
                    locText.textContent = lesson.location || 'Consultar sede';
                    mapBtn.classList.remove('hidden');
                    actionBtn.textContent = "Confirmar Asistencia";
                    // L√≥gica para confirmar asistencia podr√≠a ser marcar como completado
                }
            }

            updateButtonUI(isCompleted);
            renderLessons();
        }

        function updateButtonUI(isCompleted) {
            const btn = document.getElementById('btn-complete');
            const btnText = document.getElementById('btn-text');
            if (isCompleted) {
                btn.className = "flex-1 md:flex-none bg-green-100 text-green-700 px-8 py-4 rounded-2xl font-900 text-xs uppercase tracking-widest transition-all flex items-center justify-center gap-3";
                btnText.textContent = "Completada";
            } else {
                btn.className = "flex-1 md:flex-none bg-gray-100 text-gray-400 px-8 py-4 rounded-2xl font-900 text-xs uppercase tracking-widest hover:brightness-95 transition-all flex items-center justify-center gap-3 active:scale-95";
                btnText.textContent = "Marcar como Visto";
            }
        }

        async function toggleCompletion() {
            if (currentLessonIndex === -1) return;
            const lesson = currentLessons[currentLessonIndex];
            const isCompleted = completedLessonIds.has(lesson.id);

            try {
                if (isCompleted) {
                    await supabaseClient.from('user_progress').delete().match({ profile_id: profileId, lesson_id: lesson.id });
                    completedLessonIds.delete(lesson.id);
                } else {
                    await supabaseClient.from('user_progress').insert([{ profile_id: profileId, lesson_id: lesson.id }]);
                    completedLessonIds.add(lesson.id);
                }
                updateButtonUI(!isCompleted);
                updateProgress();
                renderLessons();
            } catch (err) { console.error(err); }
        }

        function openMap() {
            const lesson = currentLessons[currentLessonIndex];
            if (lesson && lesson.location) {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(lesson.location)}`, '_blank');
            }
        }
    </script>
</body>

</html>