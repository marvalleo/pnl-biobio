<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual - Forja Libertaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        :root {
            --pnl-blue: #0f172a;
            --pnl-gold: #fba931;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f3f4f6;
            color: var(--pnl-blue);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Sidebar Lecciones -->
    <aside class="w-full md:w-96 bg-white border-r border-gray-200 flex flex-col h-full z-10">
        <div class="p-6 border-b border-gray-100 flex items-center gap-4">
            <a href="forja-academia.html" class="hover:bg-gray-100 p-2 rounded-full transition-colors">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
            <div>
                <h1 id="course-title" class="font-900 uppercase text-sm leading-tight">Cargando curso...</h1>
                <p id="course-progress" class="text-[10px] font-bold text-[#fba931] uppercase mt-1">0% Completado</p>
            </div>
        </div>

        <div id="lessons-list" class="flex-1 overflow-y-auto p-4 space-y-2">
            <!-- Renderizado dinámico de lecciones -->
            <div class="animate-pulse space-y-4">
                <div class="h-12 bg-gray-100 rounded-xl"></div>
                <div class="h-12 bg-gray-100 rounded-xl"></div>
                <div class="h-12 bg-gray-100 rounded-xl"></div>
            </div>
        </div>
    </aside>

    <!-- Reproductor Principal -->
    <main class="flex-1 flex flex-col relative">
        <div class="flex-1 bg-black flex items-center justify-center relative group">
            <!-- Placeholder de Video / Iframe -->
            <div id="video-container" class="w-full h-full max-h-[80vh] aspect-video">
                <iframe id="video-player" class="w-full h-full" src="" title="Video Player" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>

                <!-- Placeholder si no hay video -->
                <div id="no-video"
                    class="hidden absolute inset-0 flex flex-col items-center justify-center text-white p-8 text-center">
                    <span class="material-symbols-outlined text-6xl mb-4 opacity-50">play_circle_off</span>
                    <h2 class="text-xl font-bold uppercase">Selecciona una lección para comenzar</h2>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 border-t border-gray-100">
            <div class="flex justify-between items-start">
                <div>
                    <span id="lesson-module"
                        class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Módulo 1</span>
                    <h2 id="lesson-title" class="text-2xl font-900 uppercase mt-1">Introducción al Curso</h2>
                </div>
                <button onclick="markAsCompleted()" id="btn-complete"
                    class="bg-gray-100 text-gray-400 px-6 py-3 rounded-xl font-900 text-xs uppercase tracking-widest hover:bg-[#fba931] hover:text-[#0f172a] transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">check_circle</span>
                    <span id="btn-text">Marcar como Visto</span>
                </button>
            </div>
            <p id="lesson-desc" class="mt-4 text-gray-600 text-sm leading-relaxed max-w-3xl">
                Selecciona una lección del menú lateral para ver su contenido y descripción.
            </p>
        </div>
    </main>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script>
        async function logout() {
            await supabaseClient.auth.signOut();
            localStorage.removeItem('pnl_user_role');
            window.location.href = 'index.html';
        }
    </script>
    </head>

    <body class="h-screen flex flex-col md:flex-row overflow-hidden bg-[#0f172a]">

        <!-- Sidebar Lecciones -->
        <aside class="w-full md:w-96 bg-white border-r border-gray-200 flex flex-col h-full z-10 shadow-xl">
            <div class="p-6 border-b border-gray-100 flex items-center gap-4">
                <a href="forja-academia.html"
                    class="hover:bg-gray-100 p-2 rounded-full transition-colors flex items-center justify-center">
                    <span class="material-symbols-outlined text-[#0f172a]">arrow_back</span>
                </a>
                <div>
                    <h1 id="course-title" class="font-900 uppercase text-sm leading-tight text-[#0f172a]">Cargando
                        curso...</h1>
                    <p id="course-progress"
                        class="text-[10px] font-black text-[#fba931] uppercase mt-1 tracking-widest">Calculando
                        progreso...</p>
                </div>
            </div>

            <div id="lessons-list" class="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-hide">
                <!-- Renderizado dinámico de lecciones -->
                <div class="p-8 text-center text-gray-400">
                    <div
                        class="animate-spin h-6 w-6 border-2 border-gray-200 border-t-[#fba931] rounded-full mx-auto mb-4">
                    </div>
                    <p class="text-[10px] uppercase font-bold">Cargando Malla...</p>
                </div>
            </div>
        </aside>

        <!-- Reproductor Principal -->
        <main class="flex-1 flex flex-col relative bg-black">
            <div class="flex-1 flex items-center justify-center relative group">
                <div id="video-container" class="w-full h-full aspect-video flex items-center justify-center">
                    <!-- Iframe placeholder -->
                    <iframe id="video-player" class="w-full h-full hidden" src="" title="Video Player" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>

                    <!-- Placeholder inicial -->
                    <div id="placeholder-overlay"
                        class="flex flex-col items-center justify-center text-white p-8 text-center">
                        <div
                            class="w-20 h-20 bg-[#fba931] rounded-full flex items-center justify-center mb-6 animate-pulse shadow-[0_0_30px_rgba(251,169,49,0.4)]">
                            <span class="material-symbols-outlined text-4xl text-[#0f172a] ml-1">play_arrow</span>
                        </div>
                        <h2 class="text-2xl font-900 uppercase tracking-tighter">Bienvenido al Aula Virtual</h2>
                        <p class="text-gray-400 text-sm mt-2 uppercase font-bold tracking-widest">Selecciona una lección
                            para comenzar la formación</p>
                    </div>
                </div>
            </div>

            <!-- Info de la Lección -->
            <div id="lesson-info"
                class="bg-white p-8 border-t border-gray-100 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] translate-y-full transition-transform duration-500">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                    <div>
                        <span id="lesson-index-text"
                            class="text-[10px] font-black text-[#fba931] uppercase tracking-[0.2em]">Lección # --</span>
                        <h2 id="lesson-title" class="text-3xl font-900 uppercase mt-1 tracking-tighter text-[#0f172a]">
                            --</h2>
                    </div>
                    <button onclick="toggleCompletion()" id="btn-complete"
                        class="w-full md:w-auto bg-gray-100 text-gray-400 px-8 py-4 rounded-2xl font-900 text-xs uppercase tracking-[0.1em] hover:brightness-95 transition-all flex items-center justify-center gap-3 active:scale-95">
                        <span class="material-symbols-outlined text-xl">check_circle</span>
                        <span id="btn-text">Cargando...</span>
                    </button>
                </div>
            </div>
        </main>

        <script>
            let currentLessons = [];
            let completedLessonIds = new Set();
            let currentLessonIndex = -1;
            let userId = null;

            window.addEventListener('DOMContentLoaded', async () => {
                const courseId = localStorage.getItem('current_course_id');
                if (!courseId) {
                    window.location.href = 'forja-academia.html';
                    return;
                }

                // 1. Obtener Usuario
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    window.location.href = 'forja-login.html';
                    return;
                }
                userId = user.id;

                // 2. Cargar Datos del Curso y Lecciones
                try {
                    // Info Curso
                    const { data: course } = await supabaseClient.from('courses').select('title').eq('id', courseId).single();
                    if (course) document.getElementById('course-title').textContent = course.title;

                    // Lecciones
                    const { data: lessons } = await supabaseClient
                        .from('lessons')
                        .select('*')
                        .eq('course_id', courseId)
                        .order('order_index', { ascending: true });

                    currentLessons = lessons || [];

                    // Progreso
                    const { data: progress } = await supabaseClient
                        .from('user_progress')
                        .select('lesson_id')
                        .eq('profile_id', userId);

                    completedLessonIds = new Set(progress.map(p => p.lesson_id));

                    renderLessons();
                } catch (err) {
                    console.error(err);
                    alert('Error al sincronizar con el aula virtual.');
                }
            });

            function renderLessons() {
                const container = document.getElementById('lessons-list');
                if (currentLessons.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-400 py-10 text-xs uppercase font-bold">Sin contenido disponible.</p>';
                    return;
                }

                container.innerHTML = currentLessons.map((lesson, index) => {
                    const isCompleted = completedLessonIds.has(lesson.id);
                    const isActive = index === currentLessonIndex;

                    return `
                    <div onclick="selectLesson(${index})" class="cursor-pointer p-5 rounded-3xl transition-all border-2 ${isActive ? 'bg-blue-50 border-[#fba931]' : 'hover:bg-gray-50 border-transparent'} group">
                        <div class="flex items-start gap-4">
                            <div class="mt-1">
                                <span class="material-symbols-outlined text-xl ${isCompleted ? 'text-green-500' : 'text-gray-200'}">
                                    ${isCompleted ? 'check_circle' : 'radio_button_unchecked'}
                                </span>
                            </div>
                            <div class="flex-1">
                                <p class="text-[9px] font-black ${isActive ? 'text-[#fba931]' : 'text-gray-300'} uppercase tracking-widest mb-1">Lección ${index + 1}</p>
                                <h3 class="font-800 text-sm leading-tight uppercase transition-colors ${isActive ? 'text-[#0f172a]' : 'text-gray-500 group-hover:text-[#0f172a]'}">${lesson.title}</h3>
                                <p class="text-[9px] font-bold text-gray-300 mt-1 uppercase">${lesson.duration || '-- min'}</p>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');

                // Actualizar %
                const percent = Math.round((completedLessonIds.size / currentLessons.length) * 100) || 0;
                const progressEl = document.getElementById('course-progress');
                progressEl.textContent = `${percent}% Completado`;
            }

            function selectLesson(index) {
                currentLessonIndex = index;
                const lesson = currentLessons[index];
                const isCompleted = completedLessonIds.has(lesson.id);

                // UI
                document.getElementById('placeholder-overlay').classList.add('hidden');
                const player = document.getElementById('video-player');
                player.classList.remove('hidden');
                player.src = lesson.video_url;

                document.getElementById('lesson-info').classList.remove('translate-y-full');
                document.getElementById('lesson-index-text').textContent = `Lección # ${index + 1}`;
                document.getElementById('lesson-title').textContent = lesson.title;

                updateButtonUI(isCompleted);
                renderLessons();
            }

            function updateButtonUI(isCompleted) {
                const btn = document.getElementById('btn-complete');
                const btnText = document.getElementById('btn-text');
                if (isCompleted) {
                    btn.classList.replace('bg-gray-100', 'bg-green-100');
                    btn.classList.replace('text-gray-400', 'text-green-700');
                    btnText.textContent = "Completada";
                } else {
                    btn.classList.replace('bg-green-100', 'bg-gray-100');
                    btn.classList.replace('text-green-700', 'text-gray-400');
                    btnText.textContent = "Marcar como Visto";
                }
            }

            async function toggleCompletion() {
                if (currentLessonIndex === -1) return;
                const lesson = currentLessons[currentLessonIndex];
                const isCompleted = completedLessonIds.has(lesson.id);

                try {
                    if (isCompleted) {
                        await supabaseClient.from('user_progress').delete().match({ profile_id: userId, lesson_id: lesson.id });
                        completedLessonIds.delete(lesson.id);
                    } else {
                        await supabaseClient.from('user_progress').insert([{ profile_id: userId, lesson_id: lesson.id }]);
                        completedLessonIds.add(lesson.id);
                    }

                    updateButtonUI(!isCompleted);
                    renderLessons();
                } catch (err) {
                    console.error(err);
                    alert('No se pudo guardar el progreso.');
                }
            }
        </script>
    </body>
</body>

</html>