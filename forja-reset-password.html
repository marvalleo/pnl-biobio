<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Establecer Contraseña - Forja Libertaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --pnl-blue: #0f172a;
            --pnl-gold: #fba931;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--pnl-blue);
            color: var(--pnl-blue);
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <div class="max-w-md w-full bg-white rounded-3xl p-8 shadow-2xl text-center border-t-8 border-[#fba931] mx-auto">
        <img src="https://pnl-biobio.netlify.app/wp-content/uploads/2026/pnl-del-biobio01.png" alt="Logo PNL"
            class="h-20 mx-auto mb-6">
        <h1 class="text-2xl font-900 uppercase mb-2 tracking-tighter">Establecer Contraseña</h1>
        <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mb-8">Seguridad de tu Cuenta</p>

        <div id="reset-container" class="space-y-4 text-left hidden">
            <!-- Mensaje Feedback -->
            <div id="feedback-message" class="hidden p-4 mb-4 rounded-lg bg-red-50 border-l-4 border-red-500">
                <p class="text-red-800 text-xs font-bold uppercase tracking-wider feedback-text"></p>
            </div>

            <div>
                <label class="text-[10px] font-black uppercase text-gray-400 ml-1">Nueva Contraseña</label>
                <input type="password" id="new-password" placeholder="Mínimo 6 caracteres"
                    class="w-full bg-gray-50 border border-gray-100 p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none transition-all font-bold text-lg">
            </div>

            <div>
                <label class="text-[10px] font-black uppercase text-gray-400 ml-1">Confirmar Contraseña</label>
                <input type="password" id="confirm-password" placeholder="Repite tu contraseña"
                    class="w-full bg-gray-50 border border-gray-100 p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none transition-all font-bold text-lg">
            </div>

            <button onclick="handleUpdatePassword()"
                class="w-full bg-[#fba931] text-[#0f172a] py-4 rounded-xl font-900 uppercase tracking-widest hover:brightness-110 active:scale-[0.98] transition-all shadow-lg">
                Guardar y Entrar
            </button>
        </div>

        <!-- Estado de Carga / Error de Token -->
        <div id="loading-state" class="py-10">
            <div class="animate-spin h-8 w-8 border-4 border-[#0f172a] border-t-transparent rounded-full mx-auto mb-4">
            </div>
            <p class="text-xs font-bold uppercase text-gray-400">Verificando enlace de seguridad...</p>
        </div>

        <div id="token-error" class="hidden py-6">
            <p class="text-red-500 font-bold uppercase text-sm mb-4">El enlace es inválido o ha expirado.</p>
            <a href="forja-activar.html"
                class="bg-gray-100 px-6 py-3 rounded-xl font-bold uppercase text-xs hover:bg-gray-200">Solicitar nuevo
                enlace</a>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <script>
        window.addEventListener('DOMContentLoaded', async () => {
            // Supabase maneja el hash de la URL (#access_token=...) automáticamente
            // y establece la sesión. Verificamos si hay sesión activa.

            // Pequeño delay para que el cliente procese el hash
            setTimeout(async () => {
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                document.getElementById('loading-state').classList.add('hidden');

                if (session) {
                    // Token válido, mostrar formulario
                    document.getElementById('reset-container').classList.remove('hidden');
                    console.log("Sesión recuperada para reset password:", session.user.email);
                } else {
                    // Token inválido o expirado
                    document.getElementById('token-error').classList.remove('hidden');
                }
            }, 1000);

            // Escuchar cambios de estado por si acaso (Magic Link flow)
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'PASSWORD_RECOVERY') {
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('reset-container').classList.remove('hidden');
                    document.getElementById('token-error').classList.add('hidden');
                }
            });
        });

        async function handleUpdatePassword() {
            const newPass = document.getElementById('new-password').value.trim();
            const confirmPass = document.getElementById('confirm-password').value.trim();
            const btn = document.querySelector('button');
            const feedbackBox = document.getElementById('feedback-message');
            const feedbackText = feedbackBox.querySelector('.feedback-text');

            feedbackBox.classList.add('hidden');

            if (newPass.length < 6) {
                showError('La contraseña debe tener al menos 6 caracteres.');
                return;
            }
            if (newPass !== confirmPass) {
                showError('Las contraseñas no coinciden.');
                return;
            }

            // UI Loading
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Guardando...';

            try {
                const { data, error } = await supabaseClient.auth.updateUser({
                    password: newPass
                });

                if (error) throw error;

                // Actualizar también el flag de must_change_password si existía
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    await supabaseClient.from('profiles').update({ must_change_password: false }).eq('auth_id', user.id);
                }

                alert('✅ Contraseña actualizada correctamente. Bienvenido.');

                // Redirigir al inicio o academia
                // Validar rol para redirigir
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('role')
                    .eq('auth_id', user.id)
                    .single();

                if (profile && ['super_admin', 'admin_forja', 'admin_votos'].includes(profile.role)) {
                    window.location.href = 'admin-dashboard.html';
                } else {
                    window.location.href = 'forja-academia.html';
                }

            } catch (err) {
                console.error(err);
                showError(err.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function showError(msg) {
            const box = document.getElementById('feedback-message');
            const text = box.querySelector('.feedback-text');
            box.classList.remove('hidden');
            text.textContent = msg;
        }
    </script>
</body>

</html>