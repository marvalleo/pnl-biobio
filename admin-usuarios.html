<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Militantes - PNL Biob√≠o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="supabase-config.js"></script>
    <style>
        :root {
            --pnl-blue: #0f172a;
            --pnl-gold: #fba931;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f8fafc;
            color: var(--pnl-blue);
        }
    </style>
</head>

<body class="min-h-screen">
    <nav class="bg-white shadow-sm border-b px-6 py-1 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <a href="admin-dashboard.html" class="flex items-center gap-3 hover:opacity-75 transition-opacity">
                <img src="wp-content/uploads/2026/pnl-del-biobio01.png" alt="Logo PNL"
                    style="max-height: 78px; margin-top: 5px;">
                <span class="h-8 w-[1px] bg-gray-300 mx-1"></span>
                <span class="font-900 uppercase tracking-tighter text-sm md:text-base">Panel Central</span>
            </a>
        </div>
        <div class="flex items-center gap-4">
            <div id="user-menu"
                class="hidden flex items-center gap-3 bg-white shadow-sm px-4 py-2 rounded-2xl border border-gray-100 transition-all hover:shadow-md">
                <div class="flex flex-col items-end mr-1">
                    <span id="nav-user-name"
                        class="text-[11px] font-900 uppercase leading-none text-[#0f172a]">Cargando...</span>
                    <span id="nav-user-role"
                        class="text-[9px] font-bold text-[#fba931] uppercase tracking-widest mt-1">Administrador</span>
                </div>
                <div
                    class="h-10 w-10 rounded-xl bg-[#0f172a] text-[#fba931] flex items-center justify-center font-black text-sm border-2 border-gray-50 shadow-inner">
                    <span id="nav-user-initials">?</span>
                </div>
                <div class="h-6 w-[1px] bg-gray-100 mx-1"></div>
                <button onclick="handleLogout()"
                    class="p-2 hover:bg-red-50 text-gray-400 hover:text-red-500 rounded-xl transition-all group flex items-center gap-2"
                    title="Cerrar Sesi√≥n">
                    <span class="material-symbols-outlined text-lg">logout</span>
                    <span class="text-[10px] font-black uppercase hidden lg:block">Salir</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-10">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-900 uppercase">Gesti√≥n de Militantes</h1>
                <p class="text-gray-500 font-medium">Control total de la base de datos de usuarios y roles.</p>
            </div>
            <div class="flex gap-2">
                <div class="relative">
                    <span
                        class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                    <input type="text" id="search-input" placeholder="Buscar por nombre, RUT o email..."
                        oninput="filterUsers()"
                        class="bg-white border border-gray-200 pl-11 pr-6 py-3 rounded-xl font-medium text-xs outline-none focus:ring-2 focus:ring-[#fba931] w-[300px] transition-all">
                </div>
                <button onclick="document.getElementById('excel-input').click()"
                    class="bg-white border border-gray-200 px-6 py-3 rounded-xl font-800 text-xs uppercase tracking-widest flex items-center gap-2 hover:bg-gray-50 transition-all">
                    <span class="material-symbols-outlined text-lg">upload_file</span> Importar Excel
                </button>
                <input type="file" id="excel-input" class="hidden" accept=".xlsx, .xls"
                    onchange="handleExcelImport(event)">
                <button onclick="openModal()"
                    class="bg-[#fba931] text-[#0f172a] px-6 py-3 rounded-xl font-800 text-xs uppercase tracking-widest flex items-center gap-2 hover:brightness-110 transition-all shadow-lg">
                    <span class="material-symbols-outlined text-lg">person_add</span> Nuevo Militante
                </button>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 border-b border-gray-100">
                    <tr>
                        <th class="px-6 py-4 text-[10px] font-black uppercase text-gray-400">Nombre Completo</th>
                        <th class="px-6 py-4 text-[10px] font-black uppercase text-gray-400">RUT</th>
                        <th class="px-6 py-4 text-[10px] font-black uppercase text-gray-400">Email</th>
                        <th class="px-6 py-4 text-[10px] font-black uppercase text-gray-400">Rol</th>
                        <th class="px-6 py-4 text-[10px] font-black uppercase text-gray-400 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <tr>
                        <td colspan="5" class="px-6 py-10 text-center text-gray-400 italic">Cargando militantes...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <div id="user-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl p-8 shadow-2xl">
            <h2 id="modal-title" class="text-2xl font-900 uppercase mb-6 flex items-center gap-2">
                <span class="material-symbols-outlined">person_add</span> Nuevo Militante
            </h2>
            <form id="user-form" onsubmit="saveUser(event)" class="space-y-4">
                <input type="hidden" id="profile-id">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="text-[10px] font-black uppercase text-gray-400">Nombre Completo *</label>
                        <input type="text" id="full_name" required
                            class="w-full bg-gray-50 border p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] font-black uppercase text-gray-400">Email (Obligatorio para login)
                            *</label>
                        <input type="email" id="email" required
                            class="w-full bg-gray-50 border p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-gray-400">RUT (Opcional)</label>
                        <input type="text" id="rut" placeholder="Ej: 12.345.678-k"
                            class="w-full bg-gray-50 border p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-gray-400">Tel√©fono</label>
                        <input type="text" id="phone_number"
                            class="w-full bg-gray-50 border p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] font-black uppercase text-gray-400">Rol asignado</label>
                        <select id="role"
                            class="w-full bg-gray-50 border p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none font-bold">
                            <option value="normal">Militante Normal</option>
                            <option value="admin_forja">Admin Academia (Forja)</option>
                            <option value="admin_votos">Admin Votaciones</option>
                            <option value="admin_foros">Admin Foros</option>
                            <option value="admin_usuarios">Admin Usuarios (Militantes)</option>
                            <option value="super_admin">Super Administrador (Total)</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 bg-gray-100 py-4 rounded-xl font-900 uppercase text-xs">Cancelar</button>
                    <button type="submit"
                        class="flex-1 bg-[#fba931] py-4 rounded-xl font-900 uppercase text-xs shadow-lg">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="whatsapp-modal"
        class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl text-center">
            <h2 class="text-2xl font-900 uppercase mb-4 text-green-600 flex items-center justify-center gap-2">
                <span class="material-symbols-outlined">check_circle</span> ¬°Creado!
            </h2>
            <div id="whatsapp-message"
                class="text-xs font-mono bg-gray-50 p-6 rounded-2xl border text-left select-all whitespace-pre-line mb-6">
            </div>
            <div class="flex gap-3">
                <button onclick="copyWhatsAppMessage()"
                    class="flex-1 bg-gray-600 text-white py-4 rounded-xl font-900 text-xs uppercase hover:bg-gray-700">Copiar</button>
                <button onclick="openWhatsApp()"
                    class="flex-1 bg-green-600 text-white py-4 rounded-xl font-900 text-xs uppercase hover:bg-green-700">WhatsApp</button>
            </div>
            <button onclick="location.reload()" class="w-full mt-4 text-gray-400 font-bold uppercase text-[10px]">Cerrar
                y Actualizar</button>
        </div>
    </div>

    <script>
        const tableBody = document.getElementById('users-table-body');
        const modal = document.getElementById('user-modal');
        let allUsers = [];

        window.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            const role = localStorage.getItem('pnl_user_role');
            if (!session || (role !== 'super_admin' && role !== 'admin_usuarios')) {
                window.location.href = 'forja-login.html';
                return;
            }
            const name = session.user.user_metadata?.full_name || session.user.email;
            document.getElementById('user-menu').classList.remove('hidden');
            document.getElementById('nav-user-name').innerText = name;
            document.getElementById('nav-user-initials').innerText = name.charAt(0).toUpperCase();
            loadUsers();
        });

        async function loadUsers() {
            const { data, error } = await supabaseClient.from('profiles').select('*').order('created_at', { ascending: false });
            if (!error) { allUsers = data; renderUsers(data); }
        }

        function renderUsers(users) {
            tableBody.innerHTML = users.map(u => `
                <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 font-bold uppercase text-xs">${u.full_name}</td>
                    <td class="px-6 py-4 text-[10px] text-gray-400">${u.rut || '---'}</td>
                    <td class="px-6 py-4 text-[10px] text-gray-400 lowercase">${u.email}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-0.5 rounded-full text-[9px] font-black uppercase 
                            ${u.role === 'super_admin' ? 'bg-purple-100 text-purple-700' :
                    u.role.startsWith('admin_') ? 'bg-blue-100 text-blue-700' :
                        'bg-gray-100 text-gray-600'}">
                            ${u.role.replace('_', ' ')}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick='editUser(${JSON.stringify(u)})' class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><span class="material-symbols-outlined">edit</span></button>
                        <button onclick="deleteUser('${u.auth_id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><span class="material-symbols-outlined">delete</span></button>
                    </td>
                </tr>
            `).join('');
        }

        function filterUsers() {
            const q = document.getElementById('search-input').value.toLowerCase();
            renderUsers(allUsers.filter(u => u.full_name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q) || (u.rut && u.rut.toLowerCase().includes(q))));
        }

        function openModal(mode = 'create') {
            document.getElementById('user-form').reset();
            document.getElementById('profile-id').value = '';
            modal.dataset.mode = mode;
            modal.classList.remove('hidden');
        }

        function closeModal() { modal.classList.add('hidden'); }

        async function saveUser(e) {
            e.preventDefault();
            const formData = {
                full_name: document.getElementById('full_name').value,
                email: document.getElementById('email').value,
                rut: document.getElementById('rut').value || null,
                phone_number: document.getElementById('phone_number').value || null,
                role: document.getElementById('role').value
            };

            const isEdit = modal.dataset.mode === 'edit';
            if (isEdit) {
                const { error } = await supabaseClient.from('profiles').update(formData).eq('id', document.getElementById('profile-id').value);
                if (!error) { alert('Militante actualizado'); location.reload(); }
            } else {
                document.body.style.cursor = 'wait';
                const { data, error } = await supabaseClient.functions.invoke('create-user-temp', { body: formData });
                document.body.style.cursor = 'default';
                if (!error) showWhatsAppModal(formData, data.tempPassword);
                else alert(error.message);
            }
        }

        let currentMsg = '';
        function showWhatsAppModal(user, pass) {
            currentMsg = `Hola ${user.full_name.split(' ')[0]},\n\nYa puedes acceder a la Forja Libertaria:\nüåê https://pnl-biobio.netlify.app/forja-login.html\n\nUsuario: ${user.email}\nClave: ${pass}\n\nDeber√°s cambiarla al entrar por primera vez. ¬°Bienvenid@!`;
            document.getElementById('whatsapp-message').innerText = currentMsg;
            document.getElementById('whatsapp-modal').classList.remove('hidden');
        }

        function copyWhatsAppMessage() { navigator.clipboard.writeText(currentMsg); alert('Copiado'); }
        function openWhatsApp() { window.open(`https://web.whatsapp.com/send?text=${encodeURIComponent(currentMsg)}`, '_blank'); }
        async function handleLogout() { await supabaseClient.auth.signOut(); localStorage.clear(); location.href = 'index.html'; }
        function editUser(u) {
            openModal('edit');
            document.getElementById('profile-id').value = u.id;
            document.getElementById('full_name').value = u.full_name;
            document.getElementById('email').value = u.email;
            document.getElementById('rut').value = u.rut || '';
            document.getElementById('phone_number').value = u.phone_number || '';
            document.getElementById('role').value = u.role;
        }
        async function deleteUser(id) {
            if (!confirm('¬øSeguro que deseas eliminar a este militante definitivamente?')) return;
            const { error } = await supabaseClient.functions.invoke('delete-user-complete', { body: { userId: id } });
            if (!error) location.reload();
        }
    </script>
</body>

</html>