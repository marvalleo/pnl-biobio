<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestiÃ³n de Militantes - PNL BiobÃ­o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --pnl-blue: #0f172a;
            --pnl-gold: #fba931;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f8fafc;
            color: var(--pnl-blue);
        }
    </style>
</head>

<body class="min-h-screen">
    <nav
        class="bg-white shadow-md border-b-4 border-[#fba931] px-6 py-1 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-6">
            <a href="admin-dashboard.html" class="flex items-center gap-3 hover:opacity-80 transition-all group">
                <img src="wp-content/uploads/2026/pnl-del-biobio01.png" alt="Logo PNL" style="max-height: 70px;">
                <div class="flex flex-col">
                    <span class="text-[9px] font-black uppercase text-[#fba931] leading-none mb-1">Base de Datos</span>
                    <span class="font-black text-lg uppercase leading-none">Militantes</span>
                </div>
            </a>

            <div class="h-8 w-[1px] bg-gray-200 hidden md:block"></div>

            <div class="hidden md:flex items-center gap-4">
                <a href="admin-dashboard.html"
                    class="flex items-center gap-1.5 text-[10px] font-black uppercase text-gray-400 hover:text-[#0f172a] transition-colors">
                    <span class="material-symbols-outlined text-lg">dashboard</span> Panel Central
                </a>
                <a href="index.html" target="_blank"
                    class="flex items-center gap-1.5 text-[10px] font-black uppercase text-gray-400 hover:text-blue-600 transition-colors">
                    <span class="material-symbols-outlined text-lg">visibility</span> Vista Usuario
                </a>
            </div>
        </div>

        <div id="user-menu-container" class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-full bg-gray-100 animate-pulse"></div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-10">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-900 uppercase tracking-tighter">PadrÃ³n de Militantes</h1>
                <p class="text-gray-400 font-bold uppercase text-[10px] tracking-widest">AdministraciÃ³n de SoberanÃ­a
                    Individual y Roles.</p>
            </div>
            <div class="flex gap-2">
                <div class="relative">
                    <span
                        class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                    <input type="text" id="search-input" placeholder="Buscar por nombre o email..."
                        oninput="filterUsers()"
                        class="bg-white border border-gray-200 pl-11 pr-6 py-3 rounded-xl font-medium text-xs outline-none focus:ring-2 focus:ring-[#fba931] w-[300px] transition-all">
                </div>
                <button onclick="document.getElementById('excel-input').click()"
                    class="bg-white border border-gray-200 px-6 py-3 rounded-xl font-800 text-xs uppercase tracking-widest flex items-center gap-2 hover:bg-gray-50 transition-all">
                    <span class="material-symbols-outlined text-lg">upload_file</span> Importar Excel
                </button>
                <input type="file" id="excel-input" class="hidden" accept=".xlsx, .xls"
                    onchange="handleExcelImport(event)">
                <button onclick="openModal()"
                    class="bg-[#fba931] text-[#0f172a] px-6 py-3 rounded-xl font-800 text-xs uppercase tracking-widest flex items-center gap-2 hover:brightness-110 transition-all shadow-lg">
                    <span class="material-symbols-outlined text-lg">person_add</span> Nuevo Militante
                </button>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 border-b border-gray-100">
                    <tr>
                        <th class="px-6 py-4 text-[10px] font-black uppercase text-gray-400">Nombre Completo</th>
                        <th class="px-6 py-4 text-[10px] font-black uppercase text-gray-400">Email</th>
                        <th class="px-6 py-4 text-[10px] font-black uppercase text-gray-400 text-center">CumpleaÃ±os</th>
                        <th class="px-6 py-4 text-[10px] font-black uppercase text-gray-400">Rol</th>
                        <th class="px-6 py-4 text-[10px] font-black uppercase text-gray-400 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <tr>
                        <td colspan="6" class="px-6 py-10 text-center text-gray-400 italic">Cargando militantes...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <div id="user-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl p-8 shadow-2xl">
            <h2 id="modal-title" class="text-2xl font-900 uppercase mb-6 flex items-center gap-2">
                <span class="material-symbols-outlined">person_add</span> Nuevo Militante
            </h2>
            <form id="user-form" onsubmit="saveUser(event)" class="space-y-4">
                <input type="hidden" id="profile-id">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="text-[10px] font-black uppercase text-gray-400">Nombre Completo *</label>
                        <input type="text" id="full_name" required
                            class="w-full bg-gray-50 border p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] font-black uppercase text-gray-400">Email (Obligatorio para login)
                            *</label>
                        <input type="email" id="email" required
                            class="w-full bg-gray-50 border p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] font-black uppercase text-gray-400">Fecha de Nacimiento</label>
                        <input type="date" id="birth_date"
                            class="w-full bg-gray-50 border p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none font-bold">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] font-black uppercase text-gray-400">Rol asignado</label>
                        <select id="role"
                            class="w-full bg-gray-50 border p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none font-bold">
                            <option value="normal">Militante Normal</option>
                            <option value="admin_forja">Admin Academia (Forja)</option>
                            <option value="admin_votos">Admin Votaciones</option>
                            <option value="admin_foros">Admin Foros</option>
                            <option value="admin_usuarios">Admin Usuarios (Militantes)</option>
                            <option value="super_admin">Super Administrador (Total)</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 bg-gray-100 py-4 rounded-xl font-900 uppercase text-xs">Cancelar</button>
                    <button type="submit"
                        class="flex-1 bg-[#fba931] py-4 rounded-xl font-900 uppercase text-xs shadow-lg">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="whatsapp-modal"
        class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl text-center">
            <h2 class="text-2xl font-900 uppercase mb-4 text-green-600 flex items-center justify-center gap-2">
                <span class="material-symbols-outlined">check_circle</span> Â¡Creado!
            </h2>
            <div id="whatsapp-message"
                class="text-xs font-mono bg-gray-50 p-6 rounded-2xl border text-left select-all whitespace-pre-line mb-6">
            </div>
            <div class="flex gap-3">
                <button onclick="copyWhatsAppMessage()"
                    class="flex-1 bg-gray-600 text-white py-4 rounded-xl font-900 text-xs uppercase hover:bg-gray-700">Copiar</button>
                <button onclick="openWhatsApp()"
                    class="flex-1 bg-green-600 text-white py-4 rounded-xl font-900 text-xs uppercase hover:bg-green-700">WhatsApp</button>
            </div>
            <button onclick="location.reload()" class="w-full mt-4 text-gray-400 font-bold uppercase text-[10px]">Cerrar
                y Actualizar</button>
        </div>
    </div>

    <script>
        const tableBody = document.getElementById('users-table-body');
        const modal = document.getElementById('user-modal');
        let allUsers = [];

        window.addEventListener('DOMContentLoaded', async () => {
            if (!window.supabaseClient) {
                showToast("Error de acceso a datos centrales.", "error");
                return;
            }

            const role = localStorage.getItem('pnl_user_role');
            if (role !== 'super_admin' && role !== 'admin_usuarios') {
                window.location.href = 'forja-login.html';
                return;
            }
            initNavbar();
            loadUsers();
        });

        async function loadUsers() {
            const { data, error } = await supabaseClient.from('profiles').select('*').order('created_at', { ascending: false });
            if (!error) { allUsers = data; renderUsers(data); }
        }

        function renderUsers(users) {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentDay = today.getDate();

            tableBody.innerHTML = users.map(u => {
                let birthdayDisplay = '---';
                let isBirthdayMonth = false;
                let isBirthdayToday = false;

                if (u.birth_date) {
                    const bdate = new Date(u.birth_date + 'T12:00:00'); // Evitar problemas de zona horaria
                    birthdayDisplay = bdate.toLocaleDateString('es-CL', { day: '2-digit', month: 'short' });
                    isBirthdayMonth = bdate.getMonth() === currentMonth;
                    isBirthdayToday = isBirthdayMonth && bdate.getDate() === currentDay;
                }

                return `
                <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 font-bold uppercase text-xs">
                        <div class="flex items-center gap-2">
                            ${u.full_name}
                            ${isBirthdayToday ? '<span class="animate-bounce" title="Â¡Hoy es su cumpleaÃ±os!">ðŸŽ‚</span>' : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-[10px] text-gray-400 lowercase">${u.email}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="text-[10px] font-bold ${isBirthdayMonth ? 'text-[#fba931] bg-yellow-50 px-2 py-1 rounded-lg' : 'text-gray-400'}">
                            ${isBirthdayMonth && !isBirthdayToday ? 'ðŸŽ‰ ' : ''}${birthdayDisplay}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-0.5 rounded-full text-[9px] font-black uppercase 
                            ${u.role === 'super_admin' ? 'bg-purple-100 text-purple-700' :
                        u.role.startsWith('admin_') ? 'bg-blue-100 text-blue-700' :
                            'bg-gray-100 text-gray-600'}">
                            ${u.role.replace('_', ' ')}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick='editUser(${JSON.stringify(u)})' class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><span class="material-symbols-outlined">edit</span></button>
                        <button onclick="deleteUser('${u.auth_id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><span class="material-symbols-outlined">delete</span></button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function filterUsers() {
            const q = document.getElementById('search-input').value.toLowerCase();
            renderUsers(allUsers.filter(u => u.full_name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q) || (u.rut && u.rut.toLowerCase().includes(q))));
        }

        function openModal(mode = 'create') {
            document.getElementById('user-form').reset();
            document.getElementById('profile-id').value = '';
            modal.dataset.mode = mode;
            modal.classList.remove('hidden');
        }

        function closeModal() { modal.classList.add('hidden'); }

        async function saveUser(e) {
            e.preventDefault();
            const formData = {
                full_name: document.getElementById('full_name').value,
                email: document.getElementById('email').value,
                birth_date: document.getElementById('birth_date').value || null,
                role: document.getElementById('role').value
            };

            const isEdit = modal.dataset.mode === 'edit';
            if (isEdit) {
                const { error } = await supabaseClient.from('profiles').update(formData).eq('id', document.getElementById('profile-id').value);
                if (!error) { showToast('Militante actualizado', 'success'); setTimeout(() => location.reload(), 1500); }
            } else {
                document.body.style.cursor = 'wait';
                const { data, error } = await supabaseClient.functions.invoke('create-user-temp', { body: formData });
                document.body.style.cursor = 'default';
                if (!error) showWhatsAppModal(formData, data.tempPassword);
                else showToast(error.message, 'error');
            }
        }

        let currentMsg = '';
        function showWhatsAppModal(user, pass) {
            currentMsg = `Hola ${user.full_name.split(' ')[0]},\n\nYa puedes acceder a la Forja Libertaria:\nðŸŒ https://pnl-biobio.netlify.app/forja-login.html\n\nUsuario: ${user.email}\nClave: ${pass}\n\nDeberÃ¡s cambiarla al entrar por primera vez. Â¡Bienvenid@!`;
            document.getElementById('whatsapp-message').innerText = currentMsg;
            document.getElementById('whatsapp-modal').classList.remove('hidden');
        }

        function copyWhatsAppMessage() { navigator.clipboard.writeText(currentMsg); showToast('Copiado al portapapeles', 'success'); }
        function openWhatsApp() { window.open(`https://web.whatsapp.com/send?text=${encodeURIComponent(currentMsg)}`, '_blank'); }
        async function handleLogout() { await supabaseClient.auth.signOut(); localStorage.clear(); location.href = 'index.html'; }
        function editUser(u) {
            openModal('edit');
            document.getElementById('profile-id').value = u.id;
            document.getElementById('full_name').value = u.full_name;
            document.getElementById('email').value = u.email;
            document.getElementById('birth_date').value = u.birth_date || '';
            document.getElementById('role').value = u.role;
        }
        async function deleteUser(id) {
            if (!confirm('Â¿Seguro que deseas eliminar a este militante definitivamente?')) return;
            const { error } = await supabaseClient.functions.invoke('delete-user-complete', { body: { userId: id } });
            if (!error) location.reload();
        }

        async function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet);

                if (rows.length === 0) return showToast('El archivo estÃ¡ vacÃ­o', 'error');

                showToast(`Procesando ${rows.length} registros...`, 'info');
                document.body.style.cursor = 'wait';

                let successCount = 0;
                let errorCount = 0;

                for (const row of rows) {
                    const userData = {
                        full_name: row['Nombre Completo'] || row.full_name || row.Nombre,
                        email: row['Email'] || row.email || row.Correo,
                        birth_date: row['Fecha de Nacimiento'] || row.birth_date,
                        role: row['Rol'] || row.role || 'normal'
                    };

                    if (userData.full_name && userData.email) {
                        try {
                            const { error } = await supabaseClient.functions.invoke('create-user-temp', { body: userData });
                            if (error) throw error;
                            successCount++;
                        } catch (err) {
                            console.error(`Error importando ${userData.email}:`, err);
                            errorCount++;
                        }
                    } else {
                        errorCount++;
                    }
                }

                document.body.style.cursor = 'default';
                if (successCount > 0) {
                    showToast(`Ã‰xito: ${successCount} usuarios creados.`, 'success');
                    loadUsers();
                }
                if (errorCount > 0) {
                    showToast(`${errorCount} registros fallaron o estaban incompletos.`, 'warning');
                }
            };
            reader.readAsArrayBuffer(file);
            // Reset input
            event.target.value = '';
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="supabase-config.js"></script>
    <script src="shared.js"></script>
</body>

</html>