<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Militantes - PNL Biob√≠o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --pnl-blue: #0f172a;
            --pnl-gold: #fba931;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f8fafc;
            color: var(--pnl-blue);
        }

        /* Utilidades de tabla compacta */
        .compact-td {
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
        }

        .sort-header {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        .sort-header:hover {
            background-color: #f1f5f9;
        }

        .sort-icon {
            font-size: 14px !important;
            vertical-align: middle;
            margin-left: 4px;
            opacity: 0.5;
        }

        .sort-header.active {
            color: var(--pnl-blue);
        }

        .sort-header.active .sort-icon {
            opacity: 1;
            color: var(--pnl-gold);
        }
    </style>
</head>

<body class="min-h-screen">
    <nav
        class="bg-white shadow-md border-b-4 border-[#fba931] px-6 py-1 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-6">
            <a href="admin-dashboard.html" class="flex items-center gap-3 hover:opacity-80 transition-all group">
                <img src="wp-content/uploads/2026/pnl-del-biobio01.png" alt="Logo PNL" style="max-height: 70px;">
                <div class="flex flex-col">
                    <span class="text-[9px] font-black uppercase text-[#fba931] leading-none mb-1">Base de Datos</span>
                    <span class="font-black text-lg uppercase leading-none">Militantes</span>
                </div>
            </a>

            <div class="h-8 w-[1px] bg-gray-200 hidden md:block"></div>

            <div class="hidden md:flex items-center gap-4">
                <a href="admin-dashboard.html"
                    class="flex items-center gap-1.5 text-[10px] font-black uppercase text-gray-400 hover:text-[#0f172a] transition-colors">
                    <span class="material-symbols-outlined text-lg">dashboard</span> Panel Central
                </a>
                <a href="index.html" target="_blank"
                    class="flex items-center gap-1.5 text-[10px] font-black uppercase text-gray-400 hover:text-blue-600 transition-colors">
                    <span class="material-symbols-outlined text-lg">visibility</span> Vista Usuario
                </a>
            </div>
        </div>

        <div id="user-menu-container" class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-full bg-gray-100 animate-pulse"></div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-10">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-900 uppercase tracking-tighter">Padr√≥n de Militantes</h1>
                <p class="text-gray-400 font-bold uppercase text-[10px] tracking-widest">Administraci√≥n de Soberan√≠a
                    Individual y Roles.</p>
            </div>
            <div class="flex gap-2">
                <div class="relative">
                    <span
                        class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                    <input type="text" id="search-input" placeholder="Buscar por nombre o email..."
                        oninput="filterUsers()"
                        class="bg-white border border-gray-200 pl-11 pr-6 py-3 rounded-xl font-medium text-xs outline-none focus:ring-2 focus:ring-[#fba931] w-[300px] transition-all">
                </div>
                <button onclick="document.getElementById('excel-input').click()"
                    class="bg-white border border-gray-200 px-6 py-3 rounded-xl font-800 text-xs uppercase tracking-widest flex items-center gap-2 hover:bg-gray-50 transition-all">
                    <span class="material-symbols-outlined text-lg">upload_file</span> Importar Excel
                </button>
                <input type="file" id="excel-input" class="hidden" accept=".xlsx, .xls"
                    onchange="handleExcelImport(event)">
                <button onclick="openModal()"
                    class="bg-[#fba931] text-[#0f172a] px-6 py-3 rounded-xl font-800 text-xs uppercase tracking-widest flex items-center gap-2 hover:brightness-110 transition-all shadow-lg">
                    <span class="material-symbols-outlined text-lg">person_add</span> Nuevo Militante
                </button>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 border-b border-gray-100">
                    <tr>
                        <th onclick="toggleSort('full_name')"
                            class="sort-header px-6 py-3 text-[10px] font-black uppercase text-gray-400"
                            id="th-full_name">
                            Nombre Completo <span class="material-symbols-outlined sort-icon">unfold_more</span>
                        </th>
                        <th onclick="toggleSort('email')"
                            class="sort-header px-6 py-3 text-[10px] font-black uppercase text-gray-400" id="th-email">
                            Email <span class="material-symbols-outlined sort-icon">unfold_more</span>
                        </th>
                        <th onclick="toggleSort('birth_date')"
                            class="sort-header px-6 py-3 text-[10px] font-black uppercase text-gray-400 text-center"
                            id="th-birth_date">
                            Cumplea√±os <span class="material-symbols-outlined sort-icon">unfold_more</span>
                        </th>
                        <th onclick="toggleSort('role')"
                            class="sort-header px-6 py-3 text-[10px] font-black uppercase text-gray-400" id="th-role">
                            Rol <span class="material-symbols-outlined sort-icon">unfold_more</span>
                        </th>
                        <th class="px-6 py-3 text-[10px] font-black uppercase text-gray-400 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <tr>
                        <td colspan="5" class="px-6 py-10 text-center text-gray-400 italic">Cargando militantes...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Paginaci√≥n -->
        <div
            class="mt-6 flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest" id="pagination-info">
                Mostrando 0-0 de 0 militantes
            </p>
            <div class="flex items-center gap-2" id="pagination-controls">
                <!-- Botones generados por JS -->
            </div>
        </div>
    </main>

    <div id="user-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl p-8 shadow-2xl">
            <h2 id="modal-title" class="text-2xl font-900 uppercase mb-6 flex items-center gap-2">
                <span class="material-symbols-outlined">person_add</span> Nuevo Militante
            </h2>
            <form id="user-form" onsubmit="saveUser(event)" class="space-y-4">
                <input type="hidden" id="profile-id">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="text-[10px] font-black uppercase text-gray-400">Nombre Completo *</label>
                        <input type="text" id="full_name" required
                            class="w-full bg-gray-50 border p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] font-black uppercase text-gray-400">Email (Obligatorio para login)
                            *</label>
                        <input type="email" id="email" required
                            class="w-full bg-gray-50 border p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] font-black uppercase text-gray-400">Fecha de Nacimiento</label>
                        <input type="date" id="birth_date"
                            class="w-full bg-gray-50 border p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none font-bold">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] font-black uppercase text-gray-400">Rol asignado</label>
                        <select id="role"
                            class="w-full bg-gray-50 border p-4 rounded-xl focus:ring-2 focus:ring-[#fba931] outline-none font-bold">
                            <option value="normal">Militante Normal</option>
                            <option value="admin_forja">Admin Academia (Forja)</option>
                            <option value="admin_votos">Admin Votaciones</option>
                            <option value="admin_foros">Admin Foros</option>
                            <option value="admin_usuarios">Admin Usuarios (Militantes)</option>
                            <option value="super_admin">Super Administrador (Total)</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 bg-gray-100 py-4 rounded-xl font-900 uppercase text-xs">Cancelar</button>
                    <button type="submit"
                        class="flex-1 bg-[#fba931] py-4 rounded-xl font-900 uppercase text-xs shadow-lg">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="whatsapp-modal"
        class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl text-center">
            <h2 class="text-2xl font-900 uppercase mb-4 text-green-600 flex items-center justify-center gap-2">
                <span class="material-symbols-outlined">check_circle</span> ¬°Creado!
            </h2>
            <div id="whatsapp-message"
                class="text-xs font-mono bg-gray-50 p-6 rounded-2xl border text-left select-all whitespace-pre-line mb-6">
            </div>
            <div class="flex gap-3">
                <button onclick="copyWhatsAppMessage()"
                    class="flex-1 bg-gray-600 text-white py-4 rounded-xl font-900 text-xs uppercase hover:bg-gray-700">Copiar</button>
                <button onclick="openWhatsApp()"
                    class="flex-1 bg-green-600 text-white py-4 rounded-xl font-900 text-xs uppercase hover:bg-green-700">WhatsApp</button>
            </div>
            <button onclick="location.reload()" class="w-full mt-4 text-gray-400 font-bold uppercase text-[10px]">Cerrar
                y Actualizar</button>
        </div>
    </div>

    <script>
        const tableBody = document.getElementById('users-table-body');
        const modal = document.getElementById('user-modal');
        let allUsers = [];
        let filteredUsers = [];

        // Estado de Paginaci√≥n y Orden
        let currentPage = 1;
        const itemsPerPage = 50;
        let sortColumn = 'created_at';
        let sortDirection = 'desc';

        window.addEventListener('DOMContentLoaded', async () => {
            if (!window.isSupabaseInit) {
                showToast("Error de acceso a datos centrales.", "error");
                return;
            }

            const role = localStorage.getItem('pnl_user_role');
            if (role !== 'super_admin' && role !== 'admin_usuarios') {
                window.location.href = 'forja-login.html';
                return;
            }
            initNavbar();
            loadUsers();
        });

        async function loadUsers() {
            const { data, error } = await supabaseClient.from('profiles').select('*');
            if (!error) {
                allUsers = data;
                filteredUsers = [...data];
                applySortingAndRendering();
            }
        }

        function toggleSort(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            currentPage = 1;
            updateSortHeaders();
            applySortingAndRendering();
        }

        function updateSortHeaders() {
            const headers = ['full_name', 'email', 'birth_date', 'role'];
            headers.forEach(h => {
                const el = document.getElementById(`th-${h}`);
                if (!el) return;
                el.classList.remove('active');
                const icon = el.querySelector('.sort-icon');
                icon.textContent = 'unfold_more';

                if (h === sortColumn) {
                    el.classList.add('active');
                    icon.textContent = sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward';
                }
            });
        }

        function applySortingAndRendering() {
            // 1. Ordenar
            filteredUsers.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];

                // Manejo de nulos
                if (valA === null || valA === undefined) valA = '';
                if (valB === null || valB === undefined) valB = '';

                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            renderUsers();
            renderPagination();
        }

        function renderUsers() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentDay = today.getDate();

            // Slicing para paginaci√≥n
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedUsers = filteredUsers.slice(start, end);

            if (paginatedUsers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-gray-400 italic">No se encontraron militantes.</td></tr>';
                return;
            }

            tableBody.innerHTML = paginatedUsers.map(u => {
                let birthdayDisplay = '---';
                let isBirthdayMonth = false;
                let isBirthdayToday = false;

                if (u.birth_date) {
                    const bdate = new Date(u.birth_date + 'T12:00:00');
                    birthdayDisplay = bdate.toLocaleDateString('es-CL', { day: '2-digit', month: 'short' });
                    isBirthdayMonth = bdate.getMonth() === currentMonth;
                    isBirthdayToday = isBirthdayMonth && bdate.getDate() === currentDay;
                }

                return `
                <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                    <td class="px-6 compact-td font-bold uppercase text-[11px]">
                        <div class="flex items-center gap-2">
                            ${u.full_name}
                            ${isBirthdayToday ? '<span class="animate-bounce" title="¬°Hoy es su cumplea√±os!">üéÇ</span>' : ''}
                        </div>
                    </td>
                    <td class="px-6 compact-td text-[10px] text-gray-400 lowercase">${u.email}</td>
                    <td class="px-6 compact-td text-center">
                        <span class="text-[10px] font-bold ${isBirthdayMonth ? 'text-[#fba931] bg-yellow-50 px-2 py-0.5 rounded-lg' : 'text-gray-400'}">
                            ${isBirthdayMonth && !isBirthdayToday ? 'üéâ ' : ''}${birthdayDisplay}
                        </span>
                    </td>
                    <td class="px-6 compact-td">
                        <span class="px-2 py-0.5 rounded-full text-[8px] font-black uppercase 
                            ${u.role === 'super_admin' ? 'bg-purple-100 text-purple-700' :
                        u.role.startsWith('admin_') ? 'bg-blue-100 text-blue-700' :
                            'bg-gray-100 text-gray-600'}">
                            ${u.role.replace('_', ' ')}
                        </span>
                    </td>
                    <td class="px-6 compact-td text-right">
                        <button onclick='editUser(${JSON.stringify(u)})' class="p-1 text-blue-500 hover:bg-blue-50 rounded-lg"><span class="material-symbols-outlined text-lg">edit</span></button>
                        <button onclick="deleteUser('${u.auth_id}')" class="p-1 text-red-500 hover:bg-red-50 rounded-lg"><span class="material-symbols-outlined text-lg">delete</span></button>
                    </td>
                </tr>
            `;
            }).join('');

            // Actualizar info de paginaci√≥n
            const total = filteredUsers.length;
            const shownStart = total === 0 ? 0 : start + 1;
            const shownEnd = Math.min(end, total);
            document.getElementById('pagination-info').textContent = `Mostrando ${shownStart}-${shownEnd} de ${total} militantes`;
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
            const container = document.getElementById('pagination-controls');
            container.innerHTML = '';

            if (totalPages <= 1) return;

            // Bot√≥n Anterior
            const prevBtn = document.createElement('button');
            prevBtn.className = `p-2 rounded-xl transition-all ${currentPage > 1 ? 'hover:bg-gray-100 text-gray-600' : 'text-gray-200 cursor-not-allowed'}`;
            prevBtn.innerHTML = '<span class="material-symbols-outlined">chevron_left</span>';
            prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; renderUsers(); renderPagination(); } };
            container.appendChild(prevBtn);

            // N√∫meros de p√°gina (simplificado: solo actual, primera, √∫ltima si hay muchas)
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

            for (let i = startPage; i <= endPage; i++) {
                const pBtn = document.createElement('button');
                pBtn.className = `w-8 h-8 rounded-xl text-[10px] font-black transition-all ${i === currentPage ? 'bg-[#fba931] text-[#0f172a] shadow-md' : 'text-gray-400 hover:bg-gray-50'}`;
                pBtn.textContent = i;
                pBtn.onclick = () => { currentPage = i; renderUsers(); renderPagination(); };
                container.appendChild(pBtn);
            }

            // Bot√≥n Siguiente
            const nextBtn = document.createElement('button');
            nextBtn.className = `p-2 rounded-xl transition-all ${currentPage < totalPages ? 'hover:bg-gray-100 text-gray-600' : 'text-gray-200 cursor-not-allowed'}`;
            nextBtn.innerHTML = '<span class="material-symbols-outlined">chevron_right</span>';
            nextBtn.onclick = () => { if (currentPage < totalPages) { currentPage++; renderUsers(); renderPagination(); } };
            container.appendChild(nextBtn);
        }

        function filterUsers() {
            const q = document.getElementById('search-input').value.toLowerCase();
            filteredUsers = allUsers.filter(u =>
                u.full_name.toLowerCase().includes(q) ||
                u.email.toLowerCase().includes(q) ||
                (u.rut && u.rut.toLowerCase().includes(q))
            );
            currentPage = 1;
            applySortingAndRendering();
        }

        function openModal(mode = 'create') {
            document.getElementById('user-form').reset();
            document.getElementById('profile-id').value = '';
            modal.dataset.mode = mode;
            modal.classList.remove('hidden');
        }

        function closeModal() { modal.classList.add('hidden'); }

        async function saveUser(e) {
            e.preventDefault();
            const formData = {
                full_name: document.getElementById('full_name').value,
                email: document.getElementById('email').value,
                birth_date: document.getElementById('birth_date').value || null,
                role: document.getElementById('role').value
            };

            const isEdit = modal.dataset.mode === 'edit';
            if (isEdit) {
                const { error } = await supabaseClient.from('profiles').update(formData).eq('id', document.getElementById('profile-id').value);
                if (!error) { showToast('Militante actualizado', 'success'); setTimeout(() => location.reload(), 1500); }
            } else {
                document.body.style.cursor = 'wait';
                const { data, error } = await supabaseClient.functions.invoke('create-user-temp', { body: formData });
                document.body.style.cursor = 'default';
                if (!error) showWhatsAppModal(formData, data.tempPassword);
                else showToast(error.message, 'error');
            }
        }

        let currentMsg = '';
        function showWhatsAppModal(user, pass) {
            currentMsg = `Hola ${user.full_name.split(' ')[0]},\n\nYa puedes acceder a la Forja Libertaria:\nüåê https://pnl-biobio.netlify.app/forja-login.html\n\nUsuario: ${user.email}\nClave: ${pass}\n\nDeber√°s cambiarla al entrar por primera vez. ¬°Bienvenid@!`;
            document.getElementById('whatsapp-message').innerText = currentMsg;
            document.getElementById('whatsapp-modal').classList.remove('hidden');
        }

        function copyWhatsAppMessage() { navigator.clipboard.writeText(currentMsg); showToast('Copiado al portapapeles', 'success'); }
        function openWhatsApp() { window.open(`https://web.whatsapp.com/send?text=${encodeURIComponent(currentMsg)}`, '_blank'); }
        async function handleLogout() { await supabaseClient.auth.signOut(); localStorage.clear(); location.href = 'index.html'; }
        function editUser(u) {
            openModal('edit');
            document.getElementById('profile-id').value = u.id;
            document.getElementById('full_name').value = u.full_name;
            document.getElementById('email').value = u.email;
            document.getElementById('birth_date').value = u.birth_date || '';
            document.getElementById('role').value = u.role;
        }
        async function deleteUser(id) {
            if (!confirm('¬øSeguro que deseas eliminar a este militante definitivamente?')) return;
            const { error } = await supabaseClient.functions.invoke('delete-user-complete', { body: { userId: id } });
            if (!error) location.reload();
        }

        async function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet);

                if (rows.length === 0) return showToast('El archivo est√° vac√≠o', 'error');

                showToast(`Procesando ${rows.length} registros...`, 'info');
                document.body.style.cursor = 'wait';

                let successCount = 0;
                let errorCount = 0;

                for (const row of rows) {
                    // Sanitizar claves y valores (quitar espacios, saltos de l√≠nea, etc)
                    const cleanRow = {};
                    Object.keys(row).forEach(key => {
                        const cleanKey = key.trim();
                        let value = row[key];
                        if (typeof value === 'string') value = value.trim();
                        cleanRow[cleanKey] = value;
                    });

                    const userData = {
                        full_name: cleanRow['Nombre Completo'] || cleanRow['full_name'] || cleanRow['Nombre'],
                        email: cleanRow['Email'] || cleanRow['email'] || cleanRow['Correo'],
                        birth_date: cleanRow['Fecha de Nacimiento'] || cleanRow['birth_date'],
                        role: cleanRow['Rol'] || cleanRow['role'] || 'normal'
                    };

                    // Limpieza espec√≠fica para Email (quitar espacios internos si existen por error de formato)
                    if (userData.email) {
                        userData.email = userData.email.replace(/\s+/g, '').toLowerCase();
                    }

                    if (userData.full_name && userData.email) {
                        try {
                            const { error } = await supabaseClient.functions.invoke('create-user-temp', { body: userData });
                            if (error) throw error;
                            successCount++;
                        } catch (err) {
                            console.error(`Error importando ${userData.email}:`, err);
                            errorCount++;
                        }
                    } else {
                        errorCount++;
                    }
                }

                document.body.style.cursor = 'default';
                if (successCount > 0) {
                    showToast(`√âxito: ${successCount} usuarios creados.`, 'success');
                    loadUsers();
                }
                if (errorCount > 0) {
                    showToast(`${errorCount} registros fallaron o estaban incompletos.`, 'warning');
                }
            };
            reader.readAsArrayBuffer(file);
            // Reset input
            event.target.value = '';
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="supabase-config.js"></script>
    <script src="shared.js"></script>
</body>

</html>