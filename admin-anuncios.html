<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Anuncios - Admin PNL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f8fafc;
        }

        .serif {
            font-family: 'Playfair Display', serif;
        }

        .premium-card {
            background: white;
            border-radius: 2rem;
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
        }

        .premium-card:hover {
            border-color: #fba931;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.05);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">
    <!-- NAVEGACIÓN -->
    <nav class="bg-[#0f172a] text-white py-4 px-6 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="admin-dashboard.html" class="material-symbols-outlined hover:text-[#fba931]">arrow_back</a>
                <h1 class="font-900 uppercase text-[10px] tracking-widest">Gestión de Anuncios Regionales</h1>
            </div>
            <div id="user-menu-container"></div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-12 w-full">
        <div class="flex flex-col md:flex-row justify-between items-end gap-6 mb-12">
            <div>
                <h2 class="serif text-5xl text-[#0f172a] mb-2">Impacto Directo</h2>
                <p class="text-gray-400 font-bold text-xs uppercase tracking-widest">Configura el anuncio global para la
                    sede</p>
            </div>
            <button onclick="openNewAnnouncementModal()"
                class="bg-[#fba931] text-[#0f172a] px-8 py-3 rounded-xl font-900 text-[10px] uppercase tracking-widest hover:brightness-110 shadow-lg shadow-amber-500/20 flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">add</span> Nuevo Anuncio
            </button>
        </div>

        <!-- Lista de Anuncios -->
        <div id="announcements-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Loading ... -->
            <div class="animate-pulse bg-white h-64 rounded-[2rem]"></div>
            <div class="animate-pulse bg-white h-64 rounded-[2rem]"></div>
            <div class="animate-pulse bg-white h-64 rounded-[2rem]"></div>
        </div>
    </main>

    <!-- Modal de Formulario -->
    <div id="formModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-md z-[500] hidden items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-xl rounded-[3rem] overflow-hidden shadow-2xl relative max-h-[90vh] flex flex-col">
            <div class="bg-[#0f172a] p-8 text-white">
                <h3 class="serif text-3xl" id="modalTitle">Nuevo Anuncio</h3>
            </div>
            <form id="announcementForm" class="p-8 space-y-4 overflow-y-auto custom-scrollbar flex-1">
                <input type="hidden" id="announcementId">
                <div>
                    <label class="text-[9px] font-black uppercase text-gray-400 block mb-1">Título del Anuncio</label>
                    <input type="text" id="title" required
                        class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-xs font-bold"
                        placeholder="¡La Región del Biobío te necesita!">
                </div>
                <div>
                    <label class="text-[9px] font-black uppercase text-gray-400 block mb-1">Contenido (Mensaje)</label>
                    <textarea id="content" required
                        class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-xs font-bold h-32"
                        placeholder="Describe la convocatoria o noticia..."></textarea>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-gray-400 block mb-1">URL de Imagen</label>
                        <input type="text" id="image_url" oninput="updatePreview()"
                            class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-xs font-bold"
                            placeholder="https://...">
                    </div>
                </div>
                <div id="image-preview-container" class="hidden">
                    <label class="text-[9px] font-black uppercase text-gray-400 block mb-1">Vista Previa</label>
                    <div class="h-32 w-full rounded-2xl overflow-hidden bg-gray-100 border border-gray-100">
                        <img id="image-preview" src="" class="w-full h-full object-cover">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-gray-400 block mb-1">Audiencia</label>
                        <select id="target_audience"
                            class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-xs font-bold">
                            <option value="all">Todo Público</option>
                            <option value="militants">Solo Militantes (Logged-in)</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-3 pt-4">
                        <input type="checkbox" id="is_active" checked class="w-4 h-4 accent-[#fba931]">
                        <label for="is_active" class="text-[10px] font-black uppercase">Activar inmediatamente</label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-gray-400 block mb-1">Tipo de Acción
                            (CTA)</label>
                        <select id="cta_type" onchange="updateCtaPlaceholder()"
                            class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-xs font-bold">
                            <option value="link">Enlace Web</option>
                            <option value="email">Enviar Correo</option>
                            <option value="whatsapp">Mensaje WhatsApp</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[9px] font-black uppercase text-gray-400 block mb-1">Dato de Acción
                            (URL/Email/Tel)</label>
                        <input type="text" id="cta_url"
                            class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-xs font-bold"
                            placeholder="https://...">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-gray-400 block mb-1">Texto del Botón</label>
                        <input type="text" id="cta_text"
                            class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-xs font-bold"
                            placeholder="Unirme Ahora">
                    </div>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 px-8 py-3 rounded-xl font-900 text-[10px] uppercase bg-gray-100 text-gray-400">Cancelar</button>
                    <button type="submit"
                        class="flex-1 bg-[#0f172a] text-white px-8 py-3 rounded-xl font-900 text-[10px] uppercase hover:bg-black shadow-xl">Guardar
                        Anuncio</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="shared.js"></script>
    <script>
        let announcements = [];

        window.addEventListener('DOMContentLoaded', async () => {
            if (!window.isSupabaseInit) return;

            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) { window.location.href = 'forja-login.html'; return; }

            const { data: profile } = await supabaseClient.from('profiles').select('role').eq('auth_id', user.id).single();
            if (!profile || profile.role !== 'super_admin') {
                alert('Acceso restringido solo a Súper Administradores.');
                window.location.href = 'admin-dashboard.html';
                return;
            }

            initNavbar();
            loadAnnouncements();
        });

        async function loadAnnouncements() {
            const list = document.getElementById('announcements-list');
            const { data, error } = await supabaseClient
                .from('regional_announcements')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                list.innerHTML = `<p class="col-span-full text-center py-10 text-red-500 font-bold">Error al cargar anuncios.</p>`;
                return;
            }

            announcements = data;
            renderAnnouncements();
        }

        function renderAnnouncements() {
            const list = document.getElementById('announcements-list');
            if (announcements.length === 0) {
                list.innerHTML = `<p class="col-span-full text-center py-12 text-gray-400 font-black uppercase text-[10px]">No hay anuncios configurados.</p>`;
                return;
            }

            list.innerHTML = announcements.map(a => {
                const isActive = a.is_active;
                const ctaIcon = a.cta_type === 'whatsapp' ?
                    `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 1 1-7.6-10.4 8.38 8.38 0 0 1 3.9 1.1L21 4z"></path></svg>` :
                    a.cta_type === 'email' ?
                        `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>` :
                        `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>`;

                const editIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
                const deleteIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`;

                return `
                <div class="premium-card p-6 flex flex-col gap-4 relative">
                    <div class="flex justify-between items-start">
                        <span class="text-[8px] font-black uppercase tracking-widest px-3 py-1 rounded-full ${isActive ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}">
                            ${isActive ? 'Activo' : 'Desactivado'}
                        </span>
                        <div class="flex gap-4">
                            <button onclick="editAnnouncement('${a.id}')" class="text-gray-300 hover:text-[#fba931] transition-colors">${editIcon}</button>
                            <button onclick="deleteAnnouncement('${a.id}')" class="text-gray-300 hover:text-red-500 transition-colors">${deleteIcon}</button>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-gray-400 opacity-50">${ctaIcon}</span>
                            <h4 class="serif text-xl text-[#0f172a]">${a.title}</h4>
                        </div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">${a.target_audience === 'all' ? 'Todo Público' : 'Solo Militantes'}</p>
                    </div>
                    <p class="text-xs text-gray-500 line-clamp-3">${a.content}</p>
                    <div class="mt-auto pt-4 border-t border-gray-50 flex items-center justify-between text-[8px] font-black text-gray-300 uppercase">
                        <span>Creado: ${new Date(a.created_at).toLocaleDateString()}</span>
                        <span class="text-[#fba931]">${a.cta_text || 'CTA'}</span>
                    </div>
                </div>
            `;
            }).join('');
        }

        function updateCtaPlaceholder() {
            const type = document.getElementById('cta_type').value;
            const input = document.getElementById('cta_url');
            if (type === 'email') input.placeholder = 'ejemplo@correo.com';
            else if (type === 'whatsapp') input.placeholder = '+56912345678';
            else input.placeholder = 'https://...';
        }

        function updatePreview() {
            const url = document.getElementById('image_url').value;
            const container = document.getElementById('image-preview-container');
            const img = document.getElementById('image-preview');

            if (url) {
                container.classList.remove('hidden');
                img.src = url;
            } else {
                container.classList.add('hidden');
            }
        }

        function openNewAnnouncementModal() {
            document.getElementById('modalTitle').innerText = 'Nuevo Anuncio';
            document.getElementById('announcementForm').reset();
            document.getElementById('announcementId').value = '';
            document.getElementById('image-preview-container').classList.add('hidden');
            updateCtaPlaceholder();
            document.getElementById('formModal').style.display = 'flex';
        }

        function editAnnouncement(id) {
            const a = announcements.find(x => x.id === id);
            if (!a) return;

            document.getElementById('modalTitle').innerText = 'Editar Anuncio';
            document.getElementById('announcementId').value = a.id;
            document.getElementById('title').value = a.title;
            document.getElementById('content').value = a.content;
            document.getElementById('image_url').value = a.image_url || '';
            document.getElementById('cta_text').value = a.cta_text || '';
            document.getElementById('cta_url').value = a.cta_url || '';
            document.getElementById('cta_type').value = a.cta_type || 'link';
            document.getElementById('target_audience').value = a.target_audience;
            document.getElementById('is_active').checked = a.is_active;

            updateCtaPlaceholder();
            updatePreview();
            document.getElementById('formModal').style.display = 'flex';
        }

        async function deleteAnnouncement(id) {
            if (!confirm('¿Estás seguro de eliminar este anuncio permanentemente?')) return;
            const { error } = await supabaseClient.from('regional_announcements').delete().eq('id', id);
            if (error) { showToast('Error al eliminar', 'error'); return; }
            showToast('Anuncio eliminado', 'success');
            loadAnnouncements();
        }

        function closeModal() {
            document.getElementById('formModal').style.display = 'none';
        }

        document.getElementById('announcementForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('announcementId').value;
            const payload = {
                title: document.getElementById('title').value,
                content: document.getElementById('content').value,
                image_url: document.getElementById('image_url').value,
                cta_text: document.getElementById('cta_text').value,
                cta_url: document.getElementById('cta_url').value,
                cta_type: document.getElementById('cta_type').value,
                target_audience: document.getElementById('target_audience').value,
                is_active: document.getElementById('is_active').checked
            };

            const action = id ?
                supabaseClient.from('regional_announcements').update(payload).eq('id', id) :
                supabaseClient.from('regional_announcements').insert(payload);

            const { error } = await action;
            if (error) { console.error(error); showToast('Error al guardar: Asegúrese de aplicar la migración SQL.', 'error'); return; }

            showToast('Anuncio guardado con éxito', 'success');
            closeModal();
            loadAnnouncements();
        });

    </script>
</body>

</html>