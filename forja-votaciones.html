<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votaciones - Forja Libertaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --pnl-blue: #0f172a;
            --pnl-gold: #fba931;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f8fafc;
            color: var(--pnl-blue);
        }

        .serif {
            font-family: 'Playfair Display', serif;
        }

        .nav-link {
            cursor: pointer;
            position: relative;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            transition: all 0.3s;
        }

        .nav-link:hover {
            color: var(--pnl-gold);
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 3px;
            bottom: -4px;
            left: 0;
            background-color: var(--pnl-gold);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- NAVEGACIÓN -->
    <nav class="bg-white shadow-sm sticky top-0 z-50 border-b-4 border-[#fba931]">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="index.html">
                    <img src="wp-content/uploads/2026/pnl-del-biobio01.png" alt="PNL Biobío" class="h-14">
                </a>
            </div>
            <div class="flex items-center gap-4 lg:gap-8">
                <a href="forja-academia.html" class="nav-link text-gray-400">Academia</a>
                <a href="forja-eventos.html" class="nav-link text-gray-400">Eventos</a>
                <a href="forja-votaciones.html" class="nav-link active">Votaciones</a>

                <div id="admin-link-container" class="hidden">
                    <a href="admin-dashboard.html"
                        class="text-[9px] font-black uppercase bg-[#0f172a] text-white px-3 py-2 rounded-lg hover:bg-black transition-colors flex items-center gap-1.5">
                        <span class="material-symbols-outlined text-sm">admin_panel_settings</span> Admin
                    </a>
                </div>

                <div id="user-menu-container" class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gray-100 animate-pulse"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- CONTENT -->
    <main class="max-w-7xl mx-auto px-6 py-12 flex-1 w-full">
        <div class="mb-12">
            <h1 class="serif text-5xl text-[#0f172a] mb-2 uppercase">Urna Digital</h1>
            <p class="text-gray-400 font-bold text-xs uppercase tracking-widest">Tu voz construye el partido</p>
        </div>

        <div id="voting-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Loading -->
            <div class="col-span-full py-20 text-center animate-pulse">
                <span class="material-symbols-outlined text-4xl text-gray-200 mb-4 animate-bounce">how_to_vote</span>
                <p class="text-[10px] font-black uppercase text-gray-300 tracking-[0.3em]">Cargando procesos
                    electorales...</p>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-100 py-10 mt-12">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <p class="text-[9px] font-black text-gray-300 uppercase tracking-widest">Voto Secreto y Universal — PNL
                Biobío</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="shared.js"></script>
    <script>
        let profileId = null;

        window.addEventListener('DOMContentLoaded', async () => {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) { window.location.href = 'forja-login.html'; return; }

            // Usar cache de sesión si existe
            let profile = JSON.parse(sessionStorage.getItem('pnl_profile'));
            if (!profile) {
                const { data } = await supabaseClient.from('profiles').select('id, role').eq('auth_id', user.id).single();
                profile = data;
                if (profile) sessionStorage.setItem('pnl_profile', JSON.stringify(profile));
            }

            if (!profile) return;
            profileId = profile.id;

            loadVotes();
            initNavbar();
        });

        async function loadVotes() {
            const grid = document.getElementById('voting-grid');
            try {
                // Traer votos abiertos y verificar si ya votó
                const [votesRes, ballotsRes] = await Promise.all([
                    supabaseClient.from('votes').select('*, vote_options(*)').eq('status', 'open').gt('deadline', new Date().toISOString()),
                    supabaseClient.from('ballots').select('vote_id').eq('profile_id', profileId)
                ]);

                if (votesRes.error) throw votesRes.error;

                const votes = votesRes.data;
                const votedIds = new Set(ballotsRes.data.map(b => b.vote_id));

                if (votes.length === 0) {
                    grid.innerHTML = '<div class="col-span-full py-20 text-center border-2 border-dashed rounded-[3rem] text-gray-400 font-bold uppercase">No hay votaciones activas en este momento.</div>';
                    return;
                }

                grid.innerHTML = votes.map(vote => {
                    const hasVoted = votedIds.has(vote.id);
                    const deadline = new Date(vote.deadline).toLocaleString();

                    return `
                        <div class="bg-white rounded-[2.5rem] p-10 shadow-xl border border-gray-100 relative overflow-hidden group">
                            <div class="absolute top-0 right-0 p-6">
                                <span class="material-symbols-outlined text-4xl opacity-5 text-[#fba931] group-hover:scale-125 transition-transform duration-700">ballot</span>
                            </div>
                            
                            <span class="bg-blue-50 text-blue-600 text-[8px] font-black px-3 py-1 rounded-full uppercase tracking-widest mb-4 inline-block">Proceso Electoral</span>
                            <h2 class="serif text-3xl mb-2 text-[#0f172a] uppercase">${vote.title}</h2>
                            <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-8 flex items-center gap-1">
                                <span class="material-symbols-outlined text-xs">timer</span> Cierre: ${deadline}
                            </p>

                            ${hasVoted ? `
                                <div class="bg-green-50 border border-green-100 p-6 rounded-2xl flex items-center gap-4">
                                    <span class="material-symbols-outlined text-green-500 text-3xl">verified</span>
                                    <div>
                                        <p class="text-xs font-black text-green-700 uppercase">Tu voto ha sido emitido</p>
                                        <p class="text-[9px] font-bold text-green-600 uppercase">Gracias por participar en la democracia interna.</p>
                                    </div>
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    <p class="text-[10px] font-black uppercase text-gray-400 mb-2">Selecciona una opción:</p>
                                    ${vote.vote_options.map(opt => `
                                        <button onclick="emitVote('${vote.id}', '${opt.id}')" 
                                                class="w-full text-left p-4 rounded-xl border-2 border-gray-100 hover:border-[#fba931] hover:bg-amber-50 transition-all font-bold text-xs uppercase flex justify-between items-center group/opt">
                                            ${opt.option_text}
                                            <span class="material-symbols-outlined text-sm opacity-0 group-hover/opt:opacity-100 text-[#fba931]">check_circle</span>
                                        </button>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    `;
                }).join('');

            } catch (err) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center text-red-500 font-black uppercase">Error al cargar urna virtual: ${err.message}</div>`;
            }
        }

        async function emitVote(voteId, optionId) {
            if (!confirm('¿Estás seguro de tu elección? El voto es secreto y no podrá ser modificado.')) return;

            try {
                const { error } = await supabaseClient.from('ballots').insert({
                    vote_id: voteId,
                    profile_id: profileId,
                    option_id: optionId
                });

                if (error) throw error;

                showToast('¡Voto emitido con éxito!', 'success');
                loadVotes();
            } catch (err) {
                showToast('Error al emitir voto: ' + err.message, 'error');
            }
        }
    </script>
</body>

</html>